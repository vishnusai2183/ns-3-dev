<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4.3. Working with CMake &#8212; ns-3 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="working-with-cmake">
<span id="id1"></span><h1><span class="section-number">4.3. </span>Working with CMake<a class="headerlink" href="#working-with-cmake" title="Link to this heading">¶</a></h1>
<p>The <em>ns-3</em> project used Waf build system in the past, but it has moved to
CMake for the ns-3.36 release.</p>
<p>CMake is very verbose and commands can be very long for basic operations.</p>
<p>The wrapper script <code class="docutils literal notranslate"><span class="pre">ns3</span></code> hides most of verbosity from CMake and provide a
Waf-like interface for command-line users.</p>
<p>It is the recommended way to work on <em>ns-3</em>, except if you are using an
IDE that supports projects that can be generated with CMake or CMake projects.</p>
<p>Here is a non-exhaustive list of IDEs that can be used:</p>
<ul class="simple">
<li><p>Support CMake projects:</p>
<ul>
<li><p>JetBrains’s <a class="reference external" href="https://www.jetbrains.com/clion/">CLion</a></p></li>
<li><p>Microsoft <a class="reference external" href="https://visualstudio.microsoft.com/">Visual Studio</a> and Visual Studio <a class="reference external" href="https://code.visualstudio.com/Download">Code</a></p></li>
</ul>
</li>
<li><p>Supported IDEs via <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">CMake generated</a> projects:</p>
<ul>
<li><p>Apple’s <a class="reference external" href="https://developer.apple.com/xcode/">XCode</a> : <code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">configure</span> <span class="pre">-G</span> <span class="pre">Xcode</span></code></p></li>
<li><p><a class="reference external" href="https://www.codeblocks.org/">CodeBlocks</a> : <code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">configure</span> <span class="pre">-G</span> <span class="pre">&quot;CodeBlocks</span> <span class="pre">-</span> <span class="pre">Ninja&quot;</span></code></p></li>
<li><p><a class="reference external" href="https://www.eclipse.org/cdt/">Eclipse</a> CDT4 : <code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">configure</span> <span class="pre">-G</span> <span class="pre">&quot;Eclipse</span> <span class="pre">CDT4</span> <span class="pre">-</span> <span class="pre">Ninja&quot;</span></code></p></li>
</ul>
</li>
</ul>
<p>Note: Ninja was used for brevity.
Both CodeBlocks and Eclipse have additional <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">generator options</a>.</p>
<p>General instructions on how to setup and use IDEs are available
in the Tutorial and will not be detailed here.</p>
<section id="configuring-the-project">
<h2><span class="section-number">4.3.1. </span>Configuring the project<a class="headerlink" href="#configuring-the-project" title="Link to this heading">¶</a></h2>
<p>After getting the code, either cloning the ns-3-dev repository or
downloading the release tarball, you will need to configure the
project to work on it.</p>
<p>There are two ways to configure the project: the easiest way
is using the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> script and the other way directly with CMake.</p>
<section id="configuring-the-project-with-ns3">
<h3><span class="section-number">4.3.1.1. </span>Configuring the project with <code class="docutils literal notranslate"><span class="pre">ns3</span></code><a class="headerlink" href="#configuring-the-project-with-ns3" title="Link to this heading">¶</a></h3>
<p>Navigate to the ns-3-dev directory, then run <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">configure</span> <span class="pre">--help</span></code> to
print the configuration options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ cd ns-3-dev</span>
<span class="go">~/ns-3-dev$ ./ns3 configure --help</span>
<span class="go">usage: ns3 configure [-h] [-d {debug,release,optimized}] [-G G]</span>
<span class="go">                   [--cxx-standard CXX_STANDARD] [--enable-asserts]</span>
<span class="go">                   [--disable-asserts] [--enable-examples]</span>
<span class="go">                   [--disable-examples] [--enable-logs]</span>
<span class="go">                   [--disable-logs] [--enable-tests]</span>
<span class="go">                   [--disable-tests] [--enable-verbose]</span>
<span class="go">                   [--disable-verbose]</span>
<span class="go">                   ...</span>

<span class="go">positional arguments:</span>
<span class="go">  configure</span>

<span class="go">optional arguments:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -d {debug,release,optimized}, --build-profile {debug,release,optimized}</span>
<span class="go">                        Build profile</span>
<span class="go">  -G G                  CMake generator (e.g.</span>
<span class="go">                        https://cmake.org/cmake/help/latest/manual/cmake-</span>
<span class="go">                        generators.7.html)</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>Note: the command output was trimmed to the most used options.</p>
<p>To configure <em>ns-3</em> in release mode, while enabling examples and tests,
run <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">configure</span> <span class="pre">-d</span> <span class="pre">release</span> <span class="pre">--enable-examples</span> <span class="pre">--enable-tests</span></code>.
To check what underlying commands dare being executed, add the
<code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> option:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 --dry-run configure -d release --enable-examples --enable-tests</span>
<span class="go">The following commands would be executed:</span>
<span class="go">mkdir cmake-cache</span>
<span class="go">cd cmake-cache; /usr/bin/cmake -DCMAKE_BUILD_TYPE=release -DNS3_NATIVE_OPTIMIZATIONS=OFF -DNS3_EXAMPLES=ON -DNS3_TESTS=ON -G Unix Makefiles .. ; cd ..</span>
</pre></div>
</div>
<p>Now we run it for real:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure -d release --enable-examples --enable-tests</span>
<span class="go">-- CCache is enabled. Precompiled headers are disabled by default.</span>
<span class="go">-- The CXX compiler identification is GNU 11.2.0</span>
<span class="go">-- The C compiler identification is GNU 11.2.0</span>
<span class="go">-- Detecting CXX compiler ABI info</span>
<span class="go">-- Detecting CXX compiler ABI info - done</span>
<span class="go">-- Check for working CXX compiler: /usr/bin/c++ - skipped</span>
<span class="go">-- Detecting CXX compile features</span>
<span class="go">-- Detecting CXX compile features - done</span>
<span class="go">...</span>
<span class="go">-- Processing src/wifi</span>
<span class="go">-- Processing src/wimax</span>
<span class="go">-- ---- Summary of optional ns-3 features:</span>
<span class="go">Build profile                 : release</span>
<span class="go">Build directory               : /ns-3-dev/build</span>
<span class="go">...</span>
<span class="go">Examples                      : ON</span>
<span class="go">...</span>
<span class="go">Tests                         : ON</span>
<span class="go">Threading Primitives          : ON</span>


<span class="go">Modules configured to be built:</span>
<span class="go">antenna                   aodv                      applications</span>
<span class="go">bridge                    buildings                 config-store</span>
<span class="go">core                      csma                      csma-layout</span>
<span class="go">...</span>
<span class="go">wifi                      wimax</span>

<span class="go">Modules that cannot be built:</span>
<span class="go">brite                     click                     openflow</span>
<span class="go">visualizer</span>


<span class="go">-- Configuring done</span>
<span class="go">-- Generating done</span>
<span class="go">-- Build files have been written to: /ns-3-dev/cmake-cache</span>
<span class="go">Finished executing the following commands:</span>
<span class="go">mkdir cmake-cache</span>
<span class="go">cd cmake-cache; /usr/bin/cmake -DCMAKE_BUILD_TYPE=release -DNS3_NATIVE_OPTIMIZATIONS=OFF -DNS3_EXAMPLES=ON -DNS3_TESTS=ON -G Unix Makefiles .. ; cd ..</span>
</pre></div>
</div>
<p>Notice that CCache is automatically used (if installed) for your convenience.</p>
<p>The summary with enabled feature shows both the <code class="docutils literal notranslate"><span class="pre">release</span></code> build type, along with
enabled examples and tests.</p>
<p>Below is a list of enabled modules and modules that cannot be built.</p>
<p>At the end, notice we print the same commands from <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code>. This is done
to familiarize Waf users with CMake and how the options names changed.</p>
<p>The mapping of the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> build profiles into the CMake build types is the following:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head" colspan="4"><p>Equivalent build profiles</p></th>
</tr>
<tr class="row-even"><th class="head" rowspan="2"><p><code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">--build-profile</span></code></p></th>
<th class="head" colspan="2"><p>CMake</p></th>
<th class="head"><p>Equivalent GCC compiler flags</p></th>
</tr>
<tr class="row-odd"><th class="head"><p>CMAKE_BUILD_TYPE</p></th>
<th class="head"><p>Additional flags</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>debug</p></td>
<td><p>debug</p></td>
<td></td>
<td><p>-g</p></td>
</tr>
<tr class="row-odd"><td><p>default</p></td>
<td><p>default</p></td>
<td></td>
<td><p>-O2 -g</p></td>
</tr>
<tr class="row-even"><td><p>release</p></td>
<td><p>release</p></td>
<td></td>
<td><p>-O3</p></td>
</tr>
<tr class="row-odd"><td><p>optimized</p></td>
<td><p>release</p></td>
<td><p>-DNS3_NATIVE_OPTIMIZATIONS=ON</p></td>
<td><p>-O3 -march=native -mtune=native</p></td>
</tr>
<tr class="row-even"><td><p>minsizerel</p></td>
<td><p>minsizerel</p></td>
<td></td>
<td><p>-Os</p></td>
</tr>
</tbody>
</table>
<p>In addition to setting compiler flags each build type also controls whether certain features are enabled or not:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">--build-profile</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">NS3_ASSERT</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">NS3_LOG</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">NS3_WARNINGS_AS_ERRORS</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>debug</p></td>
<td><p>ON</p></td>
<td><p>ON</p></td>
<td><p>ON</p></td>
</tr>
<tr class="row-odd"><td><p>default</p></td>
<td><p>ON</p></td>
<td><p>ON</p></td>
<td><p>OFF</p></td>
</tr>
<tr class="row-even"><td><p>release</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
</tr>
<tr class="row-odd"><td><p>optimized</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
</tr>
<tr class="row-even"><td><p>minsizerel</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">NS3_ASSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> control whether the assert or logging macros
are functional or compiled out.
<code class="docutils literal notranslate"><span class="pre">NS3_WARNINGS_AS_ERRORS</span></code> controls whether compiler warnings are treated
as errors and stop the build, or whether they are only warnings and
allow the build to continue.</p>
</section>
<section id="configuring-the-project-with-cmake">
<h3><span class="section-number">4.3.1.2. </span>Configuring the project with CMake<a class="headerlink" href="#configuring-the-project-with-cmake" title="Link to this heading">¶</a></h3>
<p>Navigate to the ns-3-dev directory, create a CMake cache folder,
navigate to it and run <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake.1.html">CMake</a> pointing to the ns-3-dev folder.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ cd ns-3-dev</span>
<span class="go">~/ns-3-dev$ mkdir cmake-cache</span>
<span class="go">~/ns-3-dev$ cd cmake-cache</span>
<span class="go">~/ns-3-dev/cmake-cache$ cmake ..</span>
</pre></div>
</div>
<p>You can pass additional arguments to the CMake command, to configure it. To change variable values,
you should use the -D option followed by the variable name.</p>
<p>As an example, the build type is stored in the variable named <a class="reference external" href="https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html">CMAKE_BUILD_TYPE</a>. Setting it to one
of the CMake build types shown in the table below will change compiler settings associated with those
build types and output executable and libraries names, which will receive a suffix.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>CMAKE_BUILD_TYPE</p></th>
<th class="head"><p><a class="reference external" href="https://github.com/Kitware/CMake/blob/master/Modules/Compiler/GNU.cmake">Effects (g++)</a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DEBUG</p></td>
<td><p>-g</p></td>
</tr>
<tr class="row-odd"><td><p>DEFAULT</p></td>
<td><p>-O2 -g -DNDEBUG</p></td>
</tr>
<tr class="row-even"><td><p>RELWITHDEBINFO</p></td>
<td><p>-O2 -g -DNDEBUG</p></td>
</tr>
<tr class="row-odd"><td><p>RELEASE</p></td>
<td><p>-O3 -DNDEBUG</p></td>
</tr>
<tr class="row-even"><td><p>MINSIZEREL</p></td>
<td><p>-Os -DNDEBUG</p></td>
</tr>
</tbody>
</table>
<p>You can set the build type with the following command, which assumes your terminal is inside the cache folder
created previously.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake -DCMAKE_BUILD_TYPE=DEBUG ..</span>
</pre></div>
</div>
<p>Another common option to change is the <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">generator</a>, which is the real underlying build system called by CMake.
There are many generators supported by CMake, including the ones listed in the table below.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Generators</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>MinGW Makefiles</p></td>
</tr>
<tr class="row-odd"><td><p>Unix Makefiles</p></td>
</tr>
<tr class="row-even"><td><p>MSYS Makefiles</p></td>
</tr>
<tr class="row-odd"><td><p>CodeBlocks - <em>one of the previous Makefiles</em></p></td>
</tr>
<tr class="row-even"><td><p>Eclipse CDT4 - <em>one of the previous Makefiles</em></p></td>
</tr>
<tr class="row-odd"><td><p>Ninja</p></td>
</tr>
<tr class="row-even"><td><p>Xcode</p></td>
</tr>
</tbody>
</table>
<p>To change the generator, you will need to pass one of these generators with the -G option. For example, if we
prefer Ninja to Makefiles, which are the default, we need to run the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake -G Ninja ..</span>
</pre></div>
</div>
<p>This command may fail if there are different generator files in the same CMake cache folder. It is recommended to clean up
the CMake cache folder, then recreate it and reconfigure setting the generator in the first run.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cd ..</span>
<span class="go">~/ns-3-dev$ rm -R cmake-cache &amp;&amp; mkdir cmake-cache &amp;&amp; cd cmake-cache</span>
<span class="go">~/ns-3-dev/cmake-cache$ cmake -DCMAKE_BUILD_TYPE=release -G Ninja ..</span>
</pre></div>
</div>
<p>After configuring for the first time, settings will be initialized to their
default values, and then you can use the <code class="docutils literal notranslate"><span class="pre">ccmake</span></code> command to manually change them:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ ccmake .</span>
<span class="go">CMAKE_BUILD_TYPE                 release</span>
<span class="go">CMAKE_INSTALL_PREFIX             /usr/local</span>
<span class="go">NS3_ASSERT                       OFF</span>
<span class="go">...</span>
<span class="go">NS3_EXAMPLES                     ON</span>
<span class="go">...</span>
<span class="go">NS3_LOG                          OFF</span>
<span class="go">NS3_TESTS                        ON</span>
<span class="go">NS3_VERBOSE                      OFF</span>
<span class="go">...</span>

<span class="go">CMAKE_BUILD_TYPE: Choose the type of build, options are: None Debug Release RelWithDebInfo MinSizeRel ...</span>
<span class="go">Keys: [enter] Edit an entry [d] Delete an entry                                                                                             CMake Version 3.22.1</span>
<span class="go">      [l] Show log output   [c] Configure</span>
<span class="go">      [h] Help              [q] Quit without generating</span>
<span class="go">      [t] Toggle advanced mode (currently off)</span>
</pre></div>
</div>
<p>After moving the cursor and setting the desired values, type <code class="docutils literal notranslate"><span class="pre">c</span></code> to configure CMake.</p>
<p>If you prefer doing everything with a non-interactive command, look at the main <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>
file in the ns-3-dev directory. It contains most of the option flags and their default values.
To enable both examples and tests, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake -DNS3_EXAMPLES=ON -DNS3_TESTS=ON ..</span>
</pre></div>
</div>
</section>
</section>
<section id="manually-refresh-the-cmake-cache">
<span id="id2"></span><h2><span class="section-number">4.3.2. </span>Manually refresh the CMake cache<a class="headerlink" href="#manually-refresh-the-cmake-cache" title="Link to this heading">¶</a></h2>
<p>After the project has been configured, calling <code class="docutils literal notranslate"><span class="pre">CMake</span></code> will
<a class="reference internal" href="#manually-refresh-the-cmake-cache"><span class="std std-ref">refresh the CMake cache</span></a>.
The refresh is required to discover new targets: libraries, executables and/or modules
that were created since the last run.</p>
<p>The refresh is done by running the CMake command from the CMake cache folder.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake ..</span>
</pre></div>
</div>
<p>Previous settings stored in the CMakeCache.txt will be preserved, while new modules will be
scanned and targets will be added.</p>
<p>The cache can also be refreshed with the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure</span>
</pre></div>
</div>
</section>
<section id="building-the-project">
<h2><span class="section-number">4.3.3. </span>Building the project<a class="headerlink" href="#building-the-project" title="Link to this heading">¶</a></h2>
<p>There are three ways of building the project:
using the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> script, calling <code class="docutils literal notranslate"><span class="pre">CMake</span></code> and
calling the underlying build system (e.g. Ninja) directly.
The last way is omitted, since each underlying build system
has its own unique command-line syntax.</p>
<section id="building-the-project-with-ns3">
<h3><span class="section-number">4.3.3.1. </span>Building the project with <code class="docutils literal notranslate"><span class="pre">ns3</span></code><a class="headerlink" href="#building-the-project-with-ns3" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper script makes life easier for command line users, accepting module names without
the <code class="docutils literal notranslate"><span class="pre">lib</span></code> prefix and scratch files without the <code class="docutils literal notranslate"><span class="pre">scratch_</span></code> prefix. The following command can
be used to build the entire project:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 build</span>
</pre></div>
</div>
<p>To build specific targets, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 build target_name</span>
</pre></div>
</div>
</section>
<section id="building-the-project-with-cmake">
<h3><span class="section-number">4.3.3.2. </span>Building the project with CMake<a class="headerlink" href="#building-the-project-with-cmake" title="Link to this heading">¶</a></h3>
<p>The build process of targets (either libraries, executables or custom tasks) can be done
invoking CMake build. To build all the targets, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake --build .</span>
</pre></div>
</div>
<p>Notice the single dot now refers to the <code class="docutils literal notranslate"><span class="pre">cmake-cache</span></code> directory, where the underlying
build system files are stored (referred inside CMake as <code class="docutils literal notranslate"><span class="pre">PROJECT_BINARY_DIR</span></code> or
<code class="docutils literal notranslate"><span class="pre">CMAKE_BINARY_DIR</span></code>, which have slightly different uses if working with sub-projects).</p>
<p>To build specific targets, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake --build . --target target_name</span>
</pre></div>
</div>
<p>Where target_name is a valid target name. Module libraries are prefixed with <code class="docutils literal notranslate"><span class="pre">lib</span></code> (e.g. libcore),
executables from the scratch folder are prefixed with <code class="docutils literal notranslate"><span class="pre">scratch_</span></code> (e.g. scratch_scratch-simulator).
Executables targets have their source file name without the “.cc” prefix
(e.g. sample-simulator.cc =&gt; sample-simulator).</p>
</section>
</section>
<section id="adding-a-new-module">
<h2><span class="section-number">4.3.4. </span>Adding a new module<a class="headerlink" href="#adding-a-new-module" title="Link to this heading">¶</a></h2>
<p>Adding a module is the only case where
<a class="reference internal" href="#manually-refresh-the-cmake-cache"><span class="std std-ref">manually refreshing the CMake cache</span></a> is required.</p>
<p>More information on how to create a new module are provided in <a class="reference internal" href="new-modules.html#adding-a-new-module-to-ns3"><span class="std std-ref">Adding a New Module to ns-3</span></a>.</p>
</section>
<section id="migrating-a-waf-module-to-cmake">
<h2><span class="section-number">4.3.5. </span>Migrating a Waf module to CMake<a class="headerlink" href="#migrating-a-waf-module-to-cmake" title="Link to this heading">¶</a></h2>
<p>If your module does not have external dependencies, porting is very easy.
Start by copying the module Wscript, rename them to CMakeLists.txt and then open it.</p>
<p>We are going to use the aodv module as an example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">bld</span><span class="p">):</span>
  <span class="n">module</span> <span class="o">=</span> <span class="n">bld</span><span class="o">.</span><span class="n">create_ns3_module</span><span class="p">(</span><span class="s1">&#39;aodv&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;internet&#39;</span><span class="p">,</span> <span class="s1">&#39;wifi&#39;</span><span class="p">])</span>
  <span class="n">module</span><span class="o">.</span><span class="n">includes</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
  <span class="n">module</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;model/aodv-id-cache.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-dpd.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rtable.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rqueue.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-packet.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-neighbor.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-routing-protocol.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;helper/aodv-helper.cc&#39;</span><span class="p">,</span>
      <span class="p">]</span>

  <span class="n">aodv_test</span> <span class="o">=</span> <span class="n">bld</span><span class="o">.</span><span class="n">create_ns3_module_test_library</span><span class="p">(</span><span class="s1">&#39;aodv&#39;</span><span class="p">)</span>
  <span class="n">aodv_test</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;test/aodv-id-cache-test-suite.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/aodv-test-suite.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/aodv-regression.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/bug-772.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/loopback.cc&#39;</span><span class="p">,</span>
      <span class="p">]</span>

  <span class="c1"># Tests encapsulating example programs should be listed here</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bld</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ENABLE_EXAMPLES&#39;</span><span class="p">]):</span>
      <span class="n">aodv_test</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
      <span class="c1">#   &#39;test/aodv-examples-test-suite.cc&#39;,</span>
          <span class="p">])</span>

  <span class="n">headers</span> <span class="o">=</span> <span class="n">bld</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="s1">&#39;ns3header&#39;</span><span class="p">)</span>
  <span class="n">headers</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;aodv&#39;</span>
  <span class="n">headers</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;model/aodv-id-cache.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-dpd.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rtable.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rqueue.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-packet.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-neighbor.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-routing-protocol.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;helper/aodv-helper.h&#39;</span><span class="p">,</span>
      <span class="p">]</span>

  <span class="k">if</span> <span class="n">bld</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ENABLE_EXAMPLES&#39;</span><span class="p">]:</span>
      <span class="n">bld</span><span class="o">.</span><span class="n">recurse</span><span class="p">(</span><span class="s1">&#39;examples&#39;</span><span class="p">)</span>

  <span class="n">bld</span><span class="o">.</span><span class="n">ns3_python_bindings</span><span class="p">()</span>
</pre></div>
</div>
<p>We can see the module name is <code class="docutils literal notranslate"><span class="pre">aodv</span></code> and it depends on the <code class="docutils literal notranslate"><span class="pre">internet</span></code> and the <code class="docutils literal notranslate"><span class="pre">wifi</span></code> libraries,
plus the lists of files (<code class="docutils literal notranslate"><span class="pre">module.source</span></code>, <code class="docutils literal notranslate"><span class="pre">headers.source</span></code> and <code class="docutils literal notranslate"><span class="pre">module_test.source</span></code>).</p>
<p>This translates to the following CMake lines:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">aodv</span><span class="w"> </span><span class="c"># aodv module, which can later be linked to examples and modules with ${libaodv}</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="c"># equivalent to module.source</span>
<span class="w">    </span><span class="s">helper/aodv-helper.cc</span>
<span class="w">    </span><span class="s">model/aodv-dpd.cc</span>
<span class="w">    </span><span class="s">model/aodv-id-cache.cc</span>
<span class="w">    </span><span class="s">model/aodv-neighbor.cc</span>
<span class="w">    </span><span class="s">model/aodv-packet.cc</span>
<span class="w">    </span><span class="s">model/aodv-routing-protocol.cc</span>
<span class="w">    </span><span class="s">model/aodv-rqueue.cc</span>
<span class="w">    </span><span class="s">model/aodv-rtable.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="c"># equivalent to headers.source</span>
<span class="w">    </span><span class="s">helper/aodv-helper.h</span>
<span class="w">    </span><span class="s">model/aodv-dpd.h</span>
<span class="w">    </span><span class="s">model/aodv-id-cache.h</span>
<span class="w">    </span><span class="s">model/aodv-neighbor.h</span>
<span class="w">    </span><span class="s">model/aodv-packet.h</span>
<span class="w">    </span><span class="s">model/aodv-routing-protocol.h</span>
<span class="w">    </span><span class="s">model/aodv-rqueue.h</span>
<span class="w">    </span><span class="s">model/aodv-rtable.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span><span class="w"> </span><span class="c"># depends on internet and wifi,</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">libwifi</span><span class="o">}</span><span class="w">     </span><span class="c"># but both are prefixed with lib in CMake</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="c"># equivalent to module_test.source</span>
<span class="w">    </span><span class="s">test/aodv-id-cache-test-suite.cc</span>
<span class="w">    </span><span class="s">test/aodv-regression.cc</span>
<span class="w">    </span><span class="s">test/aodv-test-suite.cc</span>
<span class="w">    </span><span class="s">test/loopback.cc</span>
<span class="w">    </span><span class="s">test/bug-772.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If your module depends on external libraries, check the section
<a class="reference internal" href="#linking-third-party-libraries">Linking third-party libraries</a>.</p>
<p>Python bindings are generated at runtime for all built modules
if NS3_PYTHON_BINDINGS is enabled.</p>
<p>Next, we need to port the examples wscript. Repeat the copy, rename and open
steps. We should have something like the following:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">bld</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">bld</span><span class="o">.</span><span class="n">create_ns3_program</span><span class="p">(</span><span class="s1">&#39;aodv&#39;</span><span class="p">,</span>
                                 <span class="p">[</span><span class="s1">&#39;wifi&#39;</span><span class="p">,</span> <span class="s1">&#39;internet&#39;</span><span class="p">,</span> <span class="s1">&#39;aodv&#39;</span><span class="p">,</span> <span class="s1">&#39;internet-apps&#39;</span><span class="p">])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;aodv.cc&#39;</span>
</pre></div>
</div>
<p>This means we create an example named <code class="docutils literal notranslate"><span class="pre">aodv</span></code> which depends on <code class="docutils literal notranslate"><span class="pre">wifi</span></code>, <code class="docutils literal notranslate"><span class="pre">internet</span></code>,
<code class="docutils literal notranslate"><span class="pre">aodv</span></code> and <code class="docutils literal notranslate"><span class="pre">internet-apps</span></code> module, and has a single source file <code class="docutils literal notranslate"><span class="pre">aodv.cc</span></code>.
This translates into the following CMake:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib_example</span><span class="p">(</span>
<span class="w">  </span><span class="s">NAME</span><span class="w"> </span><span class="s">aodv</span><span class="w"> </span><span class="c"># example named aodv</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">aodv.cc</span><span class="w"> </span><span class="c"># single source file aodv.cc</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="c"># depends on wifi, internet, aodv and internet-apps</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libwifi</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libaodv</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet-apps</span><span class="o">}</span>
<span class="p">)</span>
</pre></div>
</div>
<section id="migrating-definitions-compilation-and-linking-options">
<h3><span class="section-number">4.3.5.1. </span>Migrating definitions, compilation and linking options<a class="headerlink" href="#migrating-definitions-compilation-and-linking-options" title="Link to this heading">¶</a></h3>
<p>If your Waf modules had additional definitions, compilation or linking flags,
you also need to translate them to CMake. The easiest way to accomplish that
is using the CMake counterparts <em>BEFORE</em> defining your target.</p>
<p>If you, for example, had the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;CXXFLAGS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-fopenmp&quot;</span><span class="p">,</span> <span class="s2">&quot;-I/usr/local/include/e2sim&quot;</span><span class="p">])</span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;CXXDEFINES&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;LAPACK&quot;</span><span class="p">,</span> <span class="s2">&quot;LUSOLVER=LAPACK&quot;</span><span class="p">])</span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;LINKFLAGS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-llapack&quot;</span><span class="p">,</span> <span class="s2">&quot;-L/usr/local/src/GoToBLAS2&quot;</span><span class="p">,</span> <span class="s2">&quot;-lblas&quot;</span><span class="p">,</span> <span class="s2">&quot;-Lsrc/common&quot;</span><span class="p">,</span> <span class="s2">&quot;-lthyme&quot;</span><span class="p">])</span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;LIB&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;e2sim&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>You would need to replace it with the following counterparts:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># The settings below will impact all future target declarations</span>
<span class="c"># in the current subdirectory and its subdirectories</span>
<span class="c">#</span>
<span class="c"># a.k.a. the module, its examples and tests will have the definitions,</span>
<span class="c"># compilation options and will be linked to the specified libraries</span>
<span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-fopenmp</span><span class="p">)</span><span class="w"> </span><span class="c"># CXXFLAGS counterpart</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="s">/usr/local/include/e2sim</span><span class="p">)</span><span class="w"> </span><span class="c"># CXXFLAGS -I counterpart</span>
<span class="nb">add_definitions</span><span class="p">(</span><span class="s">-DLAPACK</span><span class="w"> </span><span class="s">-DLUSOLVER=LAPACK</span><span class="p">)</span><span class="w"> </span><span class="c"># CXXDEFINES counterpart</span>
<span class="nb">link_directories</span><span class="p">(</span><span class="s">/usr/local/src/GoToBLAS2</span><span class="w"> </span><span class="s">src/common</span><span class="p">)</span><span class="w"> </span><span class="c"># LINKFLAGS -L counterpart</span>
<span class="nb">link_libraries</span><span class="p">(</span><span class="s">lapack</span><span class="w"> </span><span class="s">blas</span><span class="w"> </span><span class="s">thyme</span><span class="w"> </span><span class="s">e2sim</span><span class="p">)</span><span class="w"> </span><span class="c"># LINKFLAGS -l or LIB counterpart</span>

<span class="c"># Target definition after changing settings</span>
<span class="nb">build_lib_example</span><span class="p">(</span>
<span class="w">    </span><span class="s">NAME</span><span class="w"> </span><span class="s">hypothetical-module</span>
<span class="w">    </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">hypothetical-module-source.cc</span>
<span class="w">    </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">      </span><span class="c"># depends on wifi, internet, aodv and internet-apps modules</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libwifi</span><span class="o">}</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libaodv</span><span class="o">}</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libinternet-apps</span><span class="o">}</span>
<span class="w">      </span><span class="c"># and lapack, blas, thyme, e2sim external libraries</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="running-programs">
<h2><span class="section-number">4.3.6. </span>Running programs<a class="headerlink" href="#running-programs" title="Link to this heading">¶</a></h2>
<p>Running programs with the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper script is pretty simple. To run the
scratch program produced by <code class="docutils literal notranslate"><span class="pre">scratch/scratch-simulator.cc</span></code>, you need the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 run scratch-simulator --no-build</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal notranslate"><span class="pre">--no-build</span></code> indicates that the program should only be executed, and not built
before execution.</p>
<p>To familiarize users with CMake, <code class="docutils literal notranslate"><span class="pre">ns3</span></code> can also print the underlying CMake
and command line commands used by adding the <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> flag.
Removing the <code class="docutils literal notranslate"><span class="pre">--no-build</span></code> flag and adding <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> to the same example,
produces the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 --dry-run run scratch-simulator</span>
<span class="go">The following commands would be executed:</span>
<span class="go">cd cmake-cache; cmake --build . -j 15 --target scratch_scratch-simulator ; cd ..</span>
<span class="go">export PATH=$PATH:~/ns-3-dev/build/lib</span>
<span class="go">export PYTHONPATH=~/ns-3-dev/build/bindings/python</span>
<span class="go">export LD_LIBRARY_PATH=~/ns-3-dev/build/lib</span>
<span class="go">./build/scratch/ns3-dev-scratch-simulator</span>
</pre></div>
</div>
<p>In the CMake build command line, notice the scratch-simulator has a <code class="docutils literal notranslate"><span class="pre">scratch_</span></code> prefix.
That is true for all the CMake scratch targets. This is done to guarantee globally unique names.
Similarly, library-related targets have <code class="docutils literal notranslate"><span class="pre">lib</span></code> as a prefix (e.g. <code class="docutils literal notranslate"><span class="pre">libcore</span></code>, <code class="docutils literal notranslate"><span class="pre">libnetwork</span></code>).</p>
<p>The next few lines exporting variables guarantee the executable can find python dependencies
(<code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code>) and linked libraries (<code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> on Unix-like, and
<code class="docutils literal notranslate"><span class="pre">PATH</span></code> on Windows). This is not necessary in platforms that support <a class="reference external" href="https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_RPATH.html">RPATH</a>.</p>
<p>Notice that when the scratch-simulator program is called on the last line, it has
a <code class="docutils literal notranslate"><span class="pre">ns3-&lt;version&gt;</span></code> prefix and could also have a build type suffix.
This is valid for all libraries and executables, but omitted in <code class="docutils literal notranslate"><span class="pre">ns3</span></code> for simplicity.</p>
<p>Debugging can be done with GDB. Again, we have the two ways to run the program.
Using the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 run scratch-simulator --no-build --gdb</span>
</pre></div>
</div>
<p>Or directly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ export PATH=$PATH:~/ns-3-dev/build/lib</span>
<span class="go">~/ns-3-dev/cmake-cache$ export PYTHONPATH=~/ns-3-dev/build/bindings/python</span>
<span class="go">~/ns-3-dev/cmake-cache$ export LD_LIBRARY_PATH=~/ns-3-dev/build/lib</span>
<span class="go">~/ns-3-dev/cmake-cache$ gdb ../build/scratch/ns3-dev-scratch-simulator</span>
</pre></div>
</div>
</section>
<section id="modifying-files">
<h2><span class="section-number">4.3.7. </span>Modifying files<a class="headerlink" href="#modifying-files" title="Link to this heading">¶</a></h2>
<p>As CMake is not a build system on itself, but a meta build system, it requires
frequent refreshes, also known as reconfigurations. Those refreshes are triggered
automatically in the following cases:</p>
<ul class="simple">
<li><p>Changes in linked libraries</p></li>
<li><p>Changes in the CMake code</p></li>
<li><p>Header changes</p></li>
<li><p>Header/source file name changes</p></li>
<li><p>Module name changes</p></li>
</ul>
<p>The following sections will detail some of these cases assuming a hypothetical module defined below.
Notice that the build_lib is the fundamental piece of every <em>ns-3</em> module, while user-settable
options and external libraries checking are optional.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">hypothetical</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w">  </span><span class="s">helper/hypothetical-helper.cc</span>
<span class="w">                </span><span class="s">model/hypothetical.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">    </span><span class="s">helper/hypothetical-helper.h</span>
<span class="w">    </span><span class="s">model/hypothetical.h</span>
<span class="w">    </span><span class="s">model/colliding-header.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
<section id="module-name-changes">
<h3><span class="section-number">4.3.7.1. </span>Module name changes<a class="headerlink" href="#module-name-changes" title="Link to this heading">¶</a></h3>
<p>Changing the module name requires changing the value of <code class="docutils literal notranslate"><span class="pre">LIBNAME</span></code>.
In the following example the name of the module seen previously is
changed from <code class="docutils literal notranslate"><span class="pre">hypothetical</span></code> to <code class="docutils literal notranslate"><span class="pre">new-hypothetical-name</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-hypothetical-name</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the module was already scanned, saving the changes and trying to build will trigger the
automatic CMake refresh. Otherwise, reconfigure the project to
<a class="reference internal" href="#manually-refresh-the-cmake-cache"><span class="std std-ref">manually refresh it</span></a>.</p>
</section>
<section id="header-source-file-name-changes">
<h3><span class="section-number">4.3.7.2. </span>Header/source file name changes<a class="headerlink" href="#header-source-file-name-changes" title="Link to this heading">¶</a></h3>
<p>Assuming the hypothetical module defined previously has a header name that collides
with a header of a different module.</p>
<p>The name of the <code class="docutils literal notranslate"><span class="pre">colliding-header.h</span></code> can be changed via the filesystem to
<code class="docutils literal notranslate"><span class="pre">non-colliding-header.h</span></code>, and the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> path needs to be updated to match
the new name. Some IDEs can do this automatically through refactoring tools.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-hypothetical-name</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">      </span><span class="s">helper/hypothetical-helper.h</span>
<span class="w">      </span><span class="s">model/hypothetical.h</span>
<span class="w">      </span><span class="s">model/non-colliding-header.h</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-ns3-modules">
<h3><span class="section-number">4.3.7.3. </span>Linking <em>ns-3</em> modules<a class="headerlink" href="#linking-ns3-modules" title="Link to this heading">¶</a></h3>
<p>Adding a dependency to another <em>ns-3</em> module just requires adding <code class="docutils literal notranslate"><span class="pre">${lib${modulename}}</span></code>
to the <code class="docutils literal notranslate"><span class="pre">LIBRARIES_TO_LINK</span></code> list, where modulename contains the value of the <em>ns-3</em>
module which will be depended upon.</p>
<p>Note: All <em>ns-3</em> module libraries are prefixed with <code class="docutils literal notranslate"><span class="pre">lib</span></code>,
as CMake requires unique global target names.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># now ${libnew-hypothetical-name} will depend on both core and internet modules</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-hypothetical-name</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-third-party-libraries">
<span id="id3"></span><h3><span class="section-number">4.3.7.4. </span>Linking third-party libraries<a class="headerlink" href="#linking-third-party-libraries" title="Link to this heading">¶</a></h3>
<p>Depending on a third-party library is a bit more complicated as we have multiple
ways to handle that within CMake.</p>
<p>Here is a short version on how to find and use third-party libraries
that should work in most cases:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># DEPENDENCY_NAME is used as a prefix to variables set by the find_external_library macro</span>
<span class="c"># HEADER_NAME(S) is(are) the name(s) of the header(s) you want to include</span>
<span class="c"># LIBRARY_NAME(S) is(are) the name(s) of the library(ies) you want to link</span>
<span class="c"># SEARCH_PATHS are the custom paths you can give if your library is not on a system path</span>
<span class="nb">find_external_library</span><span class="p">(</span><span class="s">DEPENDENCY_NAME</span><span class="w"> </span><span class="s">SQLite3</span>
<span class="w">                      </span><span class="s">HEADER_NAME</span><span class="w"> </span><span class="s">sqlite3.h</span>
<span class="w">                      </span><span class="s">LIBRARY_NAME</span><span class="w"> </span><span class="s">sqlite3</span>
<span class="w">                      </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="s">/optional/search/path/to/custom/sqlite3/library</span><span class="p">)</span>

<span class="c"># If the header(s) and library(ies) are not found, a message will be printed during the configuration</span>
<span class="c"># If the header(s) and the library(ies) are found, we can use the information found by the buildsystem</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span><span class="w"> </span><span class="c"># Notice that the contents of DEPENDENCY_NAME became a prefix for the _FOUND variable</span>
<span class="w">    </span><span class="c"># The compiler will not be able to find the include that is not on</span>
<span class="w">    </span><span class="c"># a system include path, unless we explicitly inform it</span>

<span class="w">    </span><span class="c"># This is the equivalent of -I/optional/search/path/to/custom/sqlite3/include</span>
<span class="w">    </span><span class="c"># and AFFECTS ALL the targets in the CURRENT DIRECTORY and ITS SUBDIRECTORIES</span>
<span class="w">    </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">    </span><span class="c"># The compiler should be able to locate the headers, but it still needs to be</span>
<span class="w">    </span><span class="c"># informed of the libraries that should be linked</span>

<span class="w">    </span><span class="c"># This is the equivalent of -l/optional/search/path/to/custom/sqlite3/library/libsqlite3.so</span>
<span class="w">    </span><span class="c"># and AFFECTS ALL the targets in the CURRENT DIRECTORY and ITS SUBDIRECTORIES</span>
<span class="w">    </span><span class="nb">link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>If you do not want to link the library against all the targets
(executables and other libraries) use one of the following patterns.</p>
<p><strong>If the third-party library is required</strong></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># if the third-party library is required</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># define your target</span>
<span class="w">    </span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">        </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">example</span>
<span class="w">        </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span>
<span class="w">        </span><span class="s">...</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># The LIBRARIES_TO_LINK will be translated into CMake&#39;s</span>
<span class="w">    </span><span class="c"># target_link_libraries(${libexample} PUBLIC ${SQLite3_LIBRARIES})</span>
<span class="w">    </span><span class="c"># which is equivalent to -l${SQLite3_LIBRARIES}</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>If the third-party library is optional</strong></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># And then define your target</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">    </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">example</span>
<span class="w">    </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">sqlite_libraries</span><span class="o">}</span><span class="w"> </span><span class="c"># variable can be empty</span>
<span class="w">    </span><span class="s">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>More details on how find_external_library works and the other
ways to import third-party libraries are presented next.</p>
<p>It is recommended to use a system package managers to install libraries,
but ns-3 also supports vcpkg and CPM. More information on how to
use them is available in <a class="reference internal" href="#using-c-library-managers">Using C++ library managers</a>.</p>
<section id="linking-third-party-libraries-without-cmake-or-pkgconfig-support">
<span id="id4"></span><h4><span class="section-number">4.3.7.4.1. </span>Linking third-party libraries without CMake or PkgConfig support<a class="headerlink" href="#linking-third-party-libraries-without-cmake-or-pkgconfig-support" title="Link to this heading">¶</a></h4>
<p>When the third-party library you want to use do not export CMake files to use
<code class="docutils literal notranslate"><span class="pre">find_package</span></code> or PkgConfig files to use <code class="docutils literal notranslate"><span class="pre">pkg_check_modules</span></code>, we need to
search for the headers and libraries manually. To simplify this process,
we include the macro <code class="docutils literal notranslate"><span class="pre">find_external_library</span></code> that searches for libraries and
header include directories, exporting results similarly to <code class="docutils literal notranslate"><span class="pre">find_package</span></code>.</p>
<p>Here is how it works:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">find_external_library</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Parse arguments</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">DEPENDENCY_NAME</span><span class="w"> </span><span class="s">HEADER_NAME</span><span class="w"> </span><span class="s">LIBRARY_NAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">HEADER_NAMES</span><span class="w"> </span><span class="s">LIBRARY_NAMES</span><span class="w"> </span><span class="s">PATH_SUFFIXES</span><span class="w"> </span><span class="s">SEARCH_PATHS</span><span class="p">)</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;FIND_LIB&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Set the external package/dependency name</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">name</span><span class="w"> </span><span class="o">${</span><span class="nv">FIND_LIB_DEPENDENCY_NAME</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># We process individual and list of headers and libraries by transforming them</span>
<span class="w">  </span><span class="c"># into lists</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">library_names</span><span class="w"> </span><span class="s2">&quot;${FIND_LIB_LIBRARY_NAME};${FIND_LIB_LIBRARY_NAMES}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">header_names</span><span class="w"> </span><span class="s2">&quot;${FIND_LIB_HEADER_NAME};${FIND_LIB_HEADER_NAMES}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Just changing the parsed argument name back to something shorter</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">search_paths</span><span class="w"> </span><span class="o">${</span><span class="nv">FIND_LIB_SEARCH_PATHS</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">path_suffixes</span><span class="w"> </span><span class="s2">&quot;${FIND_LIB_PATH_SUFFIXES}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">not_found_libraries</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">library_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">libraries</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Paths and suffixes where libraries will be searched on</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">library_search_paths</span>
<span class="w">          </span><span class="o">${</span><span class="nv">search_paths</span><span class="o">}</span>
<span class="w">          </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in ns-3-dev/build</span>
<span class="w">          </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_PREFIX</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in the install directory (e.g. /usr/)</span>
<span class="w">          </span><span class="o">$ENV{</span><span class="nv">LD_LIBRARY_PATH</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in LD_LIBRARY_PATH directories</span>
<span class="w">          </span><span class="o">$ENV{</span><span class="nv">PATH</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in PATH directories</span>
<span class="w">          </span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">suffixes</span><span class="w"> </span><span class="s">/build</span><span class="w"> </span><span class="s">/lib</span><span class="w"> </span><span class="s">/build/lib</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="s">/bin</span><span class="w"> </span><span class="o">${</span><span class="nv">path_suffixes</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># For each of the library names in LIBRARY_NAMES or LIBRARY_NAME</span>
<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">library</span><span class="w"> </span><span class="o">${</span><span class="nv">library_names</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># We mark this value is advanced not to pollute the configuration with</span>
<span class="w">    </span><span class="c"># ccmake with the cache variables used internally</span>
<span class="w">    </span><span class="nb">mark_as_advanced</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>

<span class="w">    </span><span class="c"># We search for the library named ${library} and store the results in</span>
<span class="w">    </span><span class="c"># ${name}_library_internal_${library}</span>
<span class="w">    </span><span class="nb">find_library</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span>
<span class="w">      </span><span class="s">HINTS</span><span class="w"> </span><span class="o">${</span><span class="nv">library_search_paths</span><span class="o">}</span>
<span class="w">      </span><span class="s">PATH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="c"># cmake-format: off</span>
<span class="w">    </span><span class="c"># Note: the PATH_SUFFIXES above apply to *ALL* PATHS and HINTS Which</span>
<span class="w">    </span><span class="c"># translates to CMake searching on standard library directories</span>
<span class="w">    </span><span class="c"># CMAKE_SYSTEM_PREFIX_PATH, user-settable CMAKE_PREFIX_PATH or</span>
<span class="w">    </span><span class="c"># CMAKE_LIBRARY_PATH and the directories listed above</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># e.g.  from Ubuntu 22.04 CMAKE_SYSTEM_PREFIX_PATH =</span>
<span class="w">    </span><span class="c"># /usr/local;/usr;/;/usr/local;/usr/X11R6;/usr/pkg;/opt</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># Searched directories without suffixes</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[0] = /usr/local/</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[1] = /usr</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[2] = /</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[6] = /opt</span>
<span class="w">    </span><span class="c"># ${LD_LIBRARY_PATH}[0]</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c"># ${LD_LIBRARY_PATH}[m]</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># Searched directories with suffixes include all of the directories above</span>
<span class="w">    </span><span class="c"># plus all suffixes</span>
<span class="w">    </span><span class="c"># PATH_SUFFIXES /build /lib /build/lib / /bin # ${path_suffixes}</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># /usr/local/build</span>
<span class="w">    </span><span class="c"># /usr/local/lib</span>
<span class="w">    </span><span class="c"># /usr/local/build/lib</span>
<span class="w">    </span><span class="c"># /usr/local/bin</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># cmake-format: on</span>
<span class="w">    </span><span class="c"># Or enable NS3_VERBOSE to print the searched paths</span>

<span class="w">    </span><span class="c"># Print tested paths to the searched library and if it was found</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_VERBOSE</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">log_find_searched_paths</span><span class="p">(</span>
<span class="w">              </span><span class="s">TARGET_TYPE</span><span class="w"> </span><span class="s">Library</span>
<span class="w">              </span><span class="s">TARGET_NAME</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_RESULT</span><span class="w"> </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="o">${</span><span class="nv">library_search_paths</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">    </span><span class="c"># After searching the library, the internal variable should have either the</span>
<span class="w">    </span><span class="c"># absolute path to the library or the name of the variable appended with</span>
<span class="w">    </span><span class="c"># -NOTFOUND</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${${name}_library_internal_${library}}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span>
<span class="w">       </span><span class="s2">&quot;${name}_library_internal_${library}-NOTFOUND&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">      </span><span class="c"># We keep track of libraries that were not found</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">not_found_libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="c"># We get the name of the parent directory of the library and append the</span>
<span class="w">      </span><span class="c"># library to a list of found libraries</span>
<span class="w">      </span><span class="nb">get_filename_component</span><span class="p">(</span>
<span class="w">        </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_dir_internal</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="s">}</span>
<span class="w">        </span><span class="s">DIRECTORY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="c"># e.g. lib/openflow.(so|dll|dylib|a) -&gt; lib</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">library_dirs</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_library_dir_internal}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="s">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="c"># For each library that was found (e.g. /usr/lib/pthread.so), get their parent</span>
<span class="w">  </span><span class="c"># directory (/usr/lib) and its parent (/usr)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">parent_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">libdir</span><span class="w"> </span><span class="o">${</span><span class="nv">library_dirs</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">get_filename_component</span><span class="p">(</span><span class="s">parent_libdir</span><span class="w"> </span><span class="o">${</span><span class="nv">libdir</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span><span class="p">)</span>
<span class="w">    </span><span class="nb">get_filename_component</span><span class="p">(</span><span class="s">parent_parent_libdir</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_libdir</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">parent_dirs</span><span class="w"> </span><span class="o">${</span><span class="nv">libdir</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_libdir</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_parent_libdir</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="c"># If we already found a library somewhere, limit the search paths for the header</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">parent_dirs</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">header_search_paths</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_dirs</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">header_skip_system_prefix</span><span class="w"> </span><span class="s">NO_CMAKE_SYSTEM_PATH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">header_search_paths</span>
<span class="w">            </span><span class="o">${</span><span class="nv">search_paths</span><span class="o">}</span>
<span class="w">            </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for headers in ns-3-dev/build</span>
<span class="w">            </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_PREFIX</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for headers in the install</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">not_found_headers</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">include_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">header</span><span class="w"> </span><span class="o">${</span><span class="nv">header_names</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># The same way with libraries, we mark the internal variable as advanced not</span>
<span class="w">    </span><span class="c"># to pollute ccmake configuration with variables used internally</span>
<span class="w">    </span><span class="nb">mark_as_advanced</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">suffixes</span>
<span class="w">            </span><span class="s">/build</span>
<span class="w">            </span><span class="s">/include</span>
<span class="w">            </span><span class="s">/build/include</span>
<span class="w">            </span><span class="s">/build/include/</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span>
<span class="w">            </span><span class="s">/include/</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span>
<span class="w">            </span><span class="s">/</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span>
<span class="w">            </span><span class="s">/</span>
<span class="w">            </span><span class="o">${</span><span class="nv">path_suffixes</span><span class="o">}</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">    </span><span class="c"># cmake-format: off</span>
<span class="w">    </span><span class="c"># Here we search for the header file named ${header} and store the result in</span>
<span class="w">    </span><span class="c"># ${name}_header_internal_${header}</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># The same way we did with libraries, here we search on</span>
<span class="w">    </span><span class="c"># CMAKE_SYSTEM_PREFIX_PATH, along with user-settable ${search_paths}, the</span>
<span class="w">    </span><span class="c"># parent directories from the libraries, CMAKE_OUTPUT_DIRECTORY and</span>
<span class="w">    </span><span class="c"># CMAKE_INSTALL_PREFIX</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># And again, for each of them, for every suffix listed /usr/local/build</span>
<span class="w">    </span><span class="c"># /usr/local/include</span>
<span class="w">    </span><span class="c"># /usr/local/build/include</span>
<span class="w">    </span><span class="c"># /usr/local/build/include/${name}</span>
<span class="w">    </span><span class="c"># /usr/local/include/${name}</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># cmake-format: on</span>
<span class="w">    </span><span class="c"># Or enable NS3_VERBOSE to get the searched paths printed while configuring</span>

<span class="w">    </span><span class="nb">find_file</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">header</span><span class="o">}</span>
<span class="w">      </span><span class="s">HINTS</span><span class="w"> </span><span class="o">${</span><span class="nv">header_search_paths</span><span class="o">}</span><span class="w"> </span><span class="c"># directory (e.g. /usr/)</span>
<span class="w">      </span><span class="o">${</span><span class="nv">header_skip_system_prefix</span><span class="o">}</span>
<span class="w">      </span><span class="s">PATH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># Print tested paths to the searched header and if it was found</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_VERBOSE</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">log_find_searched_paths</span><span class="p">(</span>
<span class="w">              </span><span class="s">TARGET_TYPE</span><span class="w"> </span><span class="s">Header</span>
<span class="w">              </span><span class="s">TARGET_NAME</span><span class="w"> </span><span class="o">${</span><span class="nv">header</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_RESULT</span><span class="w"> </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="o">${</span><span class="nv">header_search_paths</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_SYSTEM_PREFIX</span><span class="w"> </span><span class="o">${</span><span class="nv">header_skip_system_prefix</span><span class="o">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">    </span><span class="c"># If the header file was not found, append to the not-found list</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${${name}_header_internal_${header}}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span>
<span class="w">       </span><span class="s2">&quot;${name}_header_internal_${header}-NOTFOUND&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">not_found_headers</span><span class="w"> </span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="c"># If the header file was found, get their directories and the parent of</span>
<span class="w">      </span><span class="c"># their directories to add as include directories</span>
<span class="w">      </span><span class="nb">get_filename_component</span><span class="p">(</span>
<span class="w">        </span><span class="s">header_include_dir</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">DIRECTORY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="c"># e.g. include/click/ (simclick.h) -&gt; #include &lt;simclick.h&gt; should work</span>
<span class="w">      </span><span class="nb">get_filename_component</span><span class="p">(</span>
<span class="w">        </span><span class="s">header_include_dir2</span><span class="w"> </span><span class="o">${</span><span class="nv">header_include_dir</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="c"># e.g. include/(click) -&gt; #include &lt;click/simclick.h&gt; should work</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">include_dirs</span><span class="w"> </span><span class="o">${</span><span class="nv">header_include_dir</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">header_include_dir2</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Remove duplicate include directories</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">include_dirs</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span><span class="s">REMOVE_DUPLICATES</span><span class="w"> </span><span class="s">include_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># If we find both library and header, we export their values</span>
<span class="w">  </span><span class="nb">if</span><span class="p">((</span><span class="s">NOT</span><span class="w"> </span><span class="s">not_found_libraries}</span><span class="p">)</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="s">not_found_headers</span><span class="p">))</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_INCLUDE_DIRS</span><span class="w"> </span><span class="s2">&quot;${include_dirs}&quot;</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_LIBRARIES</span><span class="w"> </span><span class="s2">&quot;${libraries}&quot;</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_HEADER</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_header_internal}</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_FOUND</span><span class="w"> </span><span class="s">TRUE</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">status_message</span><span class="w"> </span><span class="s2">&quot;find_external_library: ${name} was found.&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_INCLUDE_DIRS</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_LIBRARIES</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_HEADER</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_FOUND</span><span class="w"> </span><span class="s">FALSE</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">status_message</span>
<span class="w">        </span><span class="s2">&quot;find_external_library: ${name} was not found. Missing headers: \&quot;</span><span class="o">${</span><span class="nv">not_found_headers</span><span class="o">}</span><span class="s">\&quot;</span><span class="w"> </span><span class="s">and</span><span class="w"> </span><span class="s">missing</span><span class="w"> </span><span class="s">libraries:</span><span class="w"> </span><span class="s">\&quot;${not_found_libraries}\&quot;.&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">FIND_LIB_QUIET</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;${status_message}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>Debugging why a header or a library cannot be found is fairly tricky.
For <code class="docutils literal notranslate"><span class="pre">find_external_library</span></code> users, enabling the <code class="docutils literal notranslate"><span class="pre">NS3_VERBOSE</span></code> switch
will enable the logging of search path directories for both headers and
libraries.</p>
<p>Note: The logging provided by find_external_library is an alternative to
CMake’s own <code class="docutils literal notranslate"><span class="pre">CMAKE_FIND_DEBUG_MODE=true</span></code> introduced in CMake 3.17,
which gets used by <em>ALL</em> <code class="docutils literal notranslate"><span class="pre">find_file</span></code>, <code class="docutils literal notranslate"><span class="pre">find_library</span></code>, <code class="docutils literal notranslate"><span class="pre">find_header</span></code>,
<code class="docutils literal notranslate"><span class="pre">find_package</span></code> and <code class="docutils literal notranslate"><span class="pre">find_path</span></code> calls throughout CMake and its modules.
If you are using a recent version of CMake, it is recommended to use
<a class="reference external" href="https://cmake.org/cmake/help/latest/variable/CMAKE_FIND_DEBUG_MODE.html">CMAKE_FIND_DEBUG_MODE</a> instead.</p>
<p>A commented version of the Openflow module <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> has an
example of <code class="docutils literal notranslate"><span class="pre">find_external_library</span></code> usage.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Export a user option to specify the path to a custom</span>
<span class="c"># openflow build directory.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_WITH_OPENFLOW</span>
<span class="w">    </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="s">CACHE</span><span class="w"> </span><span class="s">PATH</span>
<span class="w">          </span><span class="s2">&quot;Build with Openflow support&quot;</span>
<span class="p">)</span>
<span class="c"># We use this variable later in the ns-3-dev scope, but</span>
<span class="c"># the value would be lost if we saved it to the</span>
<span class="c"># parent scope ns-3-dev/src or ns-3-dev/contrib.</span>
<span class="c"># We set it as an INTERNAL CACHE variable to make it globally available.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_OPENFLOW</span>
<span class="w">    </span><span class="s2">&quot;OFF&quot;</span>
<span class="w">    </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span>
<span class="w">          </span><span class="s2">&quot;ON if Openflow is found&quot;</span>
<span class="p">)</span>

<span class="c"># This is the macro that searches for headers and libraries.</span>
<span class="c"># The DEPENDENCY_NAME is the equivalent of the find_package package name.</span>
<span class="c"># Resulting variables will be prefixed with DEPENDENCY_NAME.</span>
<span class="c"># - openflow_FOUND will be set to True if both headers and libraries</span>
<span class="c">#     were found and False otherwise</span>
<span class="c"># - openflow_LIBRARIES will contain a list of absolute paths to the</span>
<span class="c">#     libraries named in LIBRARY_NAME|LIBRARY_NAMES</span>
<span class="c"># - openflow_INCLUDE_DIRS will contain a list of include directories that contain</span>
<span class="c">#     headers named in HEADER_NAME|HEADER_NAMES and directories that contain</span>
<span class="c">#     those directories.</span>
<span class="c">#     e.g. searching for core-module.h will return</span>
<span class="c">#     both ns-3-dev/build/include/ns3 and ns-3-dev/build/include,</span>
<span class="c">#     allowing users to include both &lt;core-module.h&gt; and &lt;ns3/core-module.h&gt;</span>
<span class="c"># If a user-settable variable was created, it can be searched too by</span>
<span class="c"># adding it to the SEARCH_PATHS</span>
<span class="nb">find_external_library</span><span class="p">(</span>
<span class="w">  </span><span class="s">DEPENDENCY_NAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">HEADER_NAME</span><span class="w"> </span><span class="s">openflow.h</span>
<span class="w">  </span><span class="s">LIBRARY_NAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="o">${</span><span class="nv">NS3_WITH_OPENFLOW</span><span class="o">}</span><span class="w"> </span><span class="c"># user-settable search path, empty by default</span>
<span class="p">)</span>

<span class="c"># Before testing if the header and library were found ${openflow_FOUND},</span>
<span class="c"># test if openflow_FOUND was defined</span>
<span class="c"># If openflow_FOUND was not defined, the dependency name above doesn&#39;t match</span>
<span class="c"># the tested values below</span>
<span class="c"># If openflow_FOUND is set to FALSE, stop processing the module by returning</span>
<span class="c"># to the parent directory with return()</span>
<span class="nb">if</span><span class="p">((</span><span class="s">NOT</span>
<span class="w">    </span><span class="s">openflow_FOUND</span><span class="p">)</span>
<span class="w">   </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span>
<span class="w">        </span><span class="o">${</span><span class="nv">openflow_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Openflow was not found&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">return</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Check for the Boost header used by the openflow module</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span>
<span class="w">  </span><span class="s">boost/static_assert.hpp</span>
<span class="w">  </span><span class="s">BOOST_STATIC_ASSERT</span>
<span class="p">)</span>

<span class="c"># Stop processing the module if it was not found</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span>
<span class="w">  </span><span class="s">BOOST_STATIC_ASSERT</span>
<span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Openflow requires Boost static_assert.hpp&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">return</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Here we consume the include directories found by</span>
<span class="c"># find_external_library</span>
<span class="c">#</span>
<span class="c"># This will make the following work:</span>
<span class="c">#  include&lt;openflow/openflow.h&gt;</span>
<span class="c">#  include&lt;openflow.h&gt;</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">openflow_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Manually set definitions</span>
<span class="nb">add_definitions</span><span class="p">(</span>
<span class="w">  </span><span class="s">-DNS3_OPENFLOW</span>
<span class="w">  </span><span class="s">-DENABLE_OPENFLOW</span>
<span class="p">)</span>

<span class="c"># Set the cache variable indicating Openflow is enabled as</span>
<span class="c"># all dependencies were met</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_OPENFLOW</span>
<span class="w">    </span><span class="s2">&quot;ON&quot;</span>
<span class="w">    </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span>
<span class="w">          </span><span class="s2">&quot;ON if Openflow is found in NS3_WITH_OPENFLOW&quot;</span>
<span class="p">)</span>

<span class="c"># Additional compilation flag to ignore a specific warning</span>
<span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wno-stringop-truncation</span><span class="p">)</span>

<span class="c"># Call macro to create the module target</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.cc</span>
<span class="w">    </span><span class="s">model/openflow-interface.cc</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.h</span>
<span class="w">    </span><span class="s">model/openflow-interface.h</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">                    </span><span class="c"># Here we consume the list of libraries</span>
<span class="w">                    </span><span class="c"># exported by find_external_library</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">openflow_LIBRARIES</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="s">test/openflow-switch-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-third-party-libraries-using-cmake-s-find-package">
<h4><span class="section-number">4.3.7.4.2. </span>Linking third-party libraries using CMake’s find_package<a class="headerlink" href="#linking-third-party-libraries-using-cmake-s-find-package" title="Link to this heading">¶</a></h4>
<p>Assume we have a module with optional features that rely on a third-party library
that provides a FindThirdPartyPackage.cmake. This <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> file can be distributed
by <a class="reference external" href="https://github.com/Kitware/CMake/tree/master/Modules">CMake itself</a>, via library/package managers (APT, Pacman,
<a class="reference external" href="https://github.com/Microsoft/vcpkg#using-vcpkg-with-cmake">vcpkg</a>), or included to the project tree in the build-support/3rd-party directory.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">find_package(${Package})</span></code> is called, the <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> file gets processed,
and multiple variables are set. There is no hard standard in the name of those variables, nor if
they should follow the modern CMake usage, where just linking to the library will include
associated header directories, forward compile flags and so on.</p>
<p>We assume the old CMake style is the one being used, which means we need to include the include
directories provided by the <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span> <span class="pre">module</span></code>, usually exported as a variable
<code class="docutils literal notranslate"><span class="pre">${Package}_INCLUDE_DIRS</span></code>, and get a list of libraries for that module so that they can be
added to the list of libraries to link of the <em>ns-3</em> modules. Libraries are usually exported as
the variable <code class="docutils literal notranslate"><span class="pre">${Package}_LIBRARIES</span></code>.</p>
<p>As an example for the above, we use the Boost library
(excerpt from <code class="docutils literal notranslate"><span class="pre">macros-and-definitions.cmake</span></code> and <code class="docutils literal notranslate"><span class="pre">src/core/CMakeLists.txt</span></code>):</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># https://cmake.org/cmake/help/v3.10/module/FindBoost.html?highlight=module%20find#module:FindBoost</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span><span class="p">)</span>

<span class="c"># It is recommended to create either an empty list that is conditionally filled</span>
<span class="c"># and later included in the LIBRARIES_TO_LINK list unconditionally</span>
<span class="nb">set</span><span class="p">(</span><span class="s">boost_libraries</span><span class="p">)</span>

<span class="c"># If Boost is found, Boost_FOUND will be set to true, which we can then test</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">Boost_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># This will export Boost include directories to ALL subdirectories</span>
<span class="w">  </span><span class="c"># of the current CMAKE_CURRENT_SOURCE_DIR</span>
<span class="w">  </span><span class="c">#</span>
<span class="w">  </span><span class="c"># If calling this from the top-level directory (ns-3-dev), it will</span>
<span class="w">  </span><span class="c"># be used by all contrib/src modules, examples, etc</span>
<span class="w">  </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">Boost_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># This is a trick for Boost</span>
<span class="w">  </span><span class="c"># Sometimes you want to check if specific Boost headers are available,</span>
<span class="w">  </span><span class="c"># but they would not be found if they&#39;re not in system include directories</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_REQUIRED_INCLUDES</span><span class="w"> </span><span class="o">${</span><span class="nv">Boost_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># We get the list of Boost libraries and save them in the boost_libraries list</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">boost_libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">Boost_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># If Boost was found earlier, we will be able to check if Boost headers are available</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span>
<span class="w">  </span><span class="s2">&quot;boost/units/quantity.hpp&quot;</span>
<span class="w">  </span><span class="s">HAVE_BOOST_UNITS_QUANTITY</span>
<span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span>
<span class="w">  </span><span class="s2">&quot;boost/units/systems/si.hpp&quot;</span>
<span class="w">  </span><span class="s">HAVE_BOOST_UNITS_SI</span>
<span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">HAVE_BOOST_UNITS_QUANTITY</span><span class="o">}</span>
<span class="w">  </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">HAVE_BOOST_UNITS_SI</span><span class="o">}</span>
<span class="p">)</span>
<span class="w">  </span><span class="c"># Activate optional features that rely on Boost</span>
<span class="w">  </span><span class="nb">add_definitions</span><span class="p">(</span>
<span class="w">    </span><span class="s">-DHAVE_BOOST</span>
<span class="w">    </span><span class="s">-DHAVE_BOOST_UNITS</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># In this case, the Boost libraries are header-only,</span>
<span class="w">  </span><span class="c"># but in case we needed real libraries, we could add</span>
<span class="w">  </span><span class="c"># boost_libraries to either the auxiliary libraries_to_link list</span>
<span class="w">  </span><span class="c"># or the build_lib&#39;s LIBRARIES_TO_LINK list</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Boost Units have been found.&quot;</span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span>
<span class="w">    </span><span class="s">STATUS</span>
<span class="w">      </span><span class="s2">&quot;Boost Units are an optional feature of length.cc.&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> does not exist in your module path, CMake will warn you that is the case.
If <code class="docutils literal notranslate"><span class="pre">${Package_FOUND}</span></code> is set to <code class="docutils literal notranslate"><span class="pre">False</span></code>, other variables such as the ones related to libraries and
include directories might not be set, and can result in CMake failures to configure if used.</p>
<p>In case the <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> you need is not distributed by the upstream CMake project,
you can create your own and add it to <code class="docutils literal notranslate"><span class="pre">build-support/3rd-party</span></code>. This directory is included
to the <code class="docutils literal notranslate"><span class="pre">CMAKE_MODULE_PATH</span></code> variable, making it available for calls without needing to include
the file with the absolute path to it. To add more directories to the <code class="docutils literal notranslate"><span class="pre">CMAKE_MODULE_PATH</span></code>,
use the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Excerpt from build-support/macros-and-definitions.cmake</span>

<span class="c"># Add ns-3 custom modules to the module path</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/custom-modules&quot;</span><span class="p">)</span>

<span class="c"># Add the 3rd-party modules to the module path</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/3rd-party&quot;</span><span class="p">)</span>

<span class="c"># Add your new modules directory to the module path</span>
<span class="c"># (${PROJECT_SOURCE_DIR} is /path/to/ns-3-dev/)</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/new-modules&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>One of the custom Find files currently shipped by <em>ns-3</em> is the <code class="docutils literal notranslate"><span class="pre">FindGTK3.cmake</span></code> file.
GTK3 requires Harfbuzz, which has its own <code class="docutils literal notranslate"><span class="pre">FindHarfBuzz.cmake</span></code> file. Both of them
are in the <code class="docutils literal notranslate"><span class="pre">build-support/3rd-party</span></code> directory.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># You don&#39;t need to keep adding this, this is just a demonstration</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/3rd-party&quot;</span><span class="p">)</span>

<span class="c"># If the user-settable NS3_GTK3 is set, look for HarfBuzz and GTK</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_GTK3</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Use FindHarfBuzz.cmake to find HarfBuzz</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">HarfBuzz</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">  </span><span class="c"># If HarfBuzz is not found</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">HarfBuzz_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Harfbuzz is required by GTK3 and was not found.&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># FindGTK3.cmake does some weird tricks and results in warnings,</span>
<span class="w">    </span><span class="c"># that we can only suppress this way</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_SUPPRESS_DEVELOPER_WARNINGS</span><span class="w"> </span><span class="s">1</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">BOOL</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c"># If HarfBuzz is found, search for GTK</span>
<span class="w">    </span><span class="nb">find_package</span><span class="p">(</span><span class="s">GTK3</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Remove suppressions needed for quiet operations</span>
<span class="w">    </span><span class="nb">unset</span><span class="p">(</span><span class="s">CMAKE_SUPPRESS_DEVELOPER_WARNINGS</span><span class="w"> </span><span class="s">CACHE</span><span class="p">)</span>

<span class="w">    </span><span class="c"># If GTK3 is not found, inform the user</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">GTK3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GTK3 was not found. Continuing without it.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="c"># If an incompatible version is found, set the GTK3_FOUND flag to false,</span>
<span class="w">      </span><span class="c"># to make sure it won&#39;t be used later</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">GTK3_VERSION</span><span class="o">}</span><span class="w"> </span><span class="s">VERSION_LESS</span><span class="w"> </span><span class="s">3.22</span><span class="p">)</span>
<span class="w">        </span><span class="nb">set</span><span class="p">(</span><span class="s">GTK3_FOUND</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>
<span class="w">        </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GTK3 found with incompatible version ${GTK3_VERSION}&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nb">else</span><span class="p">()</span>
<span class="w">        </span><span class="c"># A compatible GTK3 version was found</span>
<span class="w">        </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GTK3 was found.&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The Stats module can use the same <code class="docutils literal notranslate"><span class="pre">find_package</span></code> macro to search for SQLite3.</p>
<p>Note: we currently use a custom macro to find Python3 and SQLite3 since
<code class="docutils literal notranslate"><span class="pre">FindPython3.cmake</span></code> and <code class="docutils literal notranslate"><span class="pre">FindSQLite3.cmake</span></code> were included in CMake 3.12 and 3.14.
More details on how to use the macro are listed in
<a class="reference internal" href="#linking-third-party-libraries-without-cmake-or-pkgconfig-support">Linking third-party libraries without CMake or PkgConfig support</a>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Set enable flag to false before checking</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_SQLITE</span><span class="w"> </span><span class="s">False</span><span class="p">)</span>

<span class="c"># In this case, SQLite presence is only checked if the user sets</span>
<span class="c"># NS3_SQLITE to ON, but your case may be different</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_SQLITE</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># FindSQLite3.cmake is used by CMake to find SQLite3</span>
<span class="w">  </span><span class="c"># QUIET flag silences most warnings from the module and let us write our own</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">SQLite3</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span><span class="w"> </span><span class="c"># FindSQLite3.cmake was included in CMake 3.14</span>

<span class="w">  </span><span class="c"># If SQLite3 was found, SQLite3_FOUND will be set to True, otherwise to False</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_SQLITE</span><span class="w"> </span><span class="s">True</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;SQLite was not found&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Here we declare empty lists, that only hold values if ENABLE_SQLITE is set to ON</span>
<span class="nb">set</span><span class="p">(</span><span class="s">sqlite_sources</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">sqlite_header</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_SQLITE</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># If SQLite was found, add the optional source files to the lists</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_sources</span>
<span class="w">      </span><span class="s">model/sqlite-data-output.cc</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_headers</span>
<span class="w">      </span><span class="s">model/sqlite-data-output.h</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># Include the include directories containing the sqlite3.h header</span>
<span class="w">  </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Copy the list of sqlite3 libraries</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span>
<span class="w">      </span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># If the semaphore header is also found,</span>
<span class="w">  </span><span class="c"># append additional optional source files to</span>
<span class="w">  </span><span class="c"># the sqlite sources and headers lists</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">HAVE_SEMAPHORE_H</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span>
<span class="w">      </span><span class="s">APPEND</span>
<span class="w">      </span><span class="s">sqlite_sources</span>
<span class="w">      </span><span class="s">model/sqlite-output.cc</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span>
<span class="w">      </span><span class="s">APPEND</span>
<span class="w">      </span><span class="s">sqlite_headers</span>
<span class="w">      </span><span class="s">model/sqlite-output.h</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Sources and headers file lists for stats are quite long,</span>
<span class="c"># so we use these auxiliary lists</span>
<span class="c"># The optional sqlite_sources and sqlite_headers can be empty or not</span>
<span class="nb">set</span><span class="p">(</span><span class="s">source_files</span>
<span class="w">    </span><span class="o">${</span><span class="nv">sqlite_sources</span><span class="o">}</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="s">model/uinteger-8-probe.cc</span>
<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">header_files</span>
<span class="w">    </span><span class="o">${</span><span class="nv">sqlite_headers</span><span class="o">}</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="s">model/uinteger-8-probe.h</span>
<span class="p">)</span>

<span class="c"># Create the stats module consuming source files</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">stats</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">source_files</span><span class="o">}</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">header_files</span><span class="o">}</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">                    </span><span class="c"># Here we either have an empty list or</span>
<span class="w">                    </span><span class="c"># a list with the sqlite library</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">sqlite_libraries</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span>
<span class="w">    </span><span class="s">test/average-test-suite.cc</span>
<span class="w">    </span><span class="s">test/basic-data-calculators-test-suite.cc</span>
<span class="w">    </span><span class="s">test/double-probe-test-suite.cc</span>
<span class="w">    </span><span class="s">test/histogram-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-third-party-libraries-with-pkgconfig-support">
<h4><span class="section-number">4.3.7.4.3. </span>Linking third-party libraries with PkgConfig support<a class="headerlink" href="#linking-third-party-libraries-with-pkgconfig-support" title="Link to this heading">¶</a></h4>
<p>Assume we have a module with optional features that rely on a third-party library
that uses PkgConfig. We can look for the PkgConfig module and add the optional
source files similarly to the previous cases, as shown in the example below:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Include CMake script to use pkg-config</span>
<span class="nb">include</span><span class="p">(</span><span class="s">FindPkgConfig</span><span class="p">)</span>

<span class="c"># If pkg-config was found, search for library you want</span>
<span class="nb">if</span><span class="p">(</span><span class="s">PKG_CONFIG_FOUND</span><span class="p">)</span>
<span class="w">  </span><span class="nb">pkg_check_modules</span><span class="p">(</span><span class="s">THIRD_PARTY</span><span class="w"> </span><span class="s">libthird-party</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">set</span><span class="p">(</span><span class="s">third_party_sources</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">third_party_libs</span><span class="p">)</span>
<span class="c"># Set cached variable if both pkg-config and libthird-party are found</span>
<span class="nb">if</span><span class="p">(</span><span class="s">PKG_CONFIG_FOUND</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="s">THIRD_PARTY</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Include third-party include directories for</span>
<span class="w">  </span><span class="c"># consumption of the current module and its examples</span>
<span class="w">  </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">THIRD_PARTY_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Use exported CFLAGS required by the third-party library</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">THIRD_PARTY_CFLAGS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Copy the list of third-party libraries</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">third_party_libs</span><span class="w"> </span><span class="o">${</span><span class="nv">THIRD_PARTY_LIBRARIES</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Add optional source files that depend on the third-party library</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">third_party_sources</span><span class="w"> </span><span class="s">model/optional-feature.cc</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Create module using the optional source files and libraries</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">hypothetical</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">model/hypothetical.cc</span>
<span class="w">               </span><span class="o">${</span><span class="nv">third_party_sources</span><span class="o">}</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">model/hypothetical.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">                    </span><span class="c"># Here we either have an empty list or</span>
<span class="w">                    </span><span class="c"># a list with the third-party library</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">third_party_libs</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span>
<span class="w">    </span><span class="s">test/hypothetical.cc</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="using-c-library-managers">
<span id="id5"></span><h3><span class="section-number">4.3.7.5. </span>Using C++ library managers<a class="headerlink" href="#using-c-library-managers" title="Link to this heading">¶</a></h3>
<p>It is not rare to try using a library that is not available
on a certain platform or does not have a CMake-friendly
interface for us to use.</p>
<p>Some C++ package managers are fairly easy to use with CMake,
such as <a class="reference external" href="https://github.com/Microsoft/vcpkg#using-vcpkg-with-cmake">Vcpkg</a> and <a class="reference external" href="https://github.com/cpm-cmake/CPM.cmake">CPM</a>.</p>
<section id="id6">
<h4><span class="section-number">4.3.7.5.1. </span>vcpkg<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h4>
<p>Vcpkg requires <code class="docutils literal notranslate"><span class="pre">git</span></code>, <code class="docutils literal notranslate"><span class="pre">curl</span></code>, <code class="docutils literal notranslate"><span class="pre">zip</span></code>, <code class="docutils literal notranslate"><span class="pre">unzip</span></code> and <code class="docutils literal notranslate"><span class="pre">tar</span></code>,
along with the default ns-3 dependencies. The setup downloads
and builds vcpkg from their Git repository. Telemetry is disabled
by default.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">Cloning into &#39;vcpkg&#39;...</span>
<span class="go">Updating files: 100% (10376/10376), done.</span>
<span class="go">Downloading vcpkg-glibc...</span>
<span class="go">vcpkg package management program version 2023-07-19-814b7ec837b59f1c8778f72351c1dd7605983cd2</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Configuration will finish successfully.
For example, now we can try using the Armadillo library.
To do that, we use the following CMake statements:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Check this is not a fluke</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Reconfigure ns-3 to check if Armadillo is available.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 configure</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">-- vcpkg: folder already exists, skipping git download</span>
<span class="go">-- vcpkg: already bootstrapped</span>
<span class="go">...</span>
<span class="go">-- Could NOT find Armadillo (missing: ARMADILLO_INCLUDE_DIR)</span>
<span class="go">-- Armadillo was found? FALSE</span>
</pre></div>
</div>
<p>As you can see, no Armadillo found.
We can now use vcpkg to install it, using the CMake
function <code class="docutils literal notranslate"><span class="pre">add_package(package_name)</span></code>. CMake
will then be able to find the installed package using <code class="docutils literal notranslate"><span class="pre">find_package</span></code>.</p>
<p>Note: some packages may require additional dependencies.
The Armadillo package requires <code class="docutils literal notranslate"><span class="pre">pkg-config</span></code> and a fortran compiler.
You will be prompted with a CMake error when a missing dependency is found.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo and search for it again</span>
<span class="nb">add_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Installs Armadillo with vcpkg</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads vcpkg installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Sadly, we will need to reconfigure ns-3 from the scratch,
since CMake <code class="docutils literal notranslate"><span class="pre">find_package</span></code> caches are problematic.
Installing the packages can take a while, and it can look like it hanged.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 clean</span>
<span class="go">~$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">-- vcpkg: folder already exists, skipping git download</span>
<span class="go">-- vcpkg: already bootstrapped</span>
<span class="go">...</span>
<span class="go">-- vcpkg: Armadillo will be installed</span>
<span class="go">-- vcpkg: Armadillo was installed</span>
<span class="go">-- Armadillo was found? TRUE</span>
</pre></div>
</div>
<p>As shown above, the Armadillo library gets installed by vcpkg
and it can be found by CMake’s <code class="docutils literal notranslate"><span class="pre">find_package</span></code> function.
We can then use it for our targets.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo</span>
<span class="nb">add_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Installs Armadillo with vcpkg</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads vcpkg installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>

<span class="c"># Include and link Armadillo to targets</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">ARMADILLO_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">ARMADILLO_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
</pre></div>
</div>
<p>An alternative to manually installing packages with <code class="docutils literal notranslate"><span class="pre">add_package</span></code> is
placing all packages into a <code class="docutils literal notranslate"><span class="pre">vcpkg.json</span></code> file in the ns-3 main directory.
This mode is known as the “manifest mode” in the Vcpkg manual.
Packages there will be automatically installed at the beginning of the configuration.
More information about the manifest mode can be found in <a class="reference external" href="https://learn.microsoft.com/en-us/vcpkg/users/manifests">vcpkg manifests</a> website.</p>
<p>Let us see an example of this mode starting with the <code class="docutils literal notranslate"><span class="pre">vcpkg.json</span></code> file.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;sqlite3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;eigen3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;libxml2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;gsl&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;boost-units&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These are some of the optional dependencies used by the upstream ns-3 modules.
When configuring ns-3 with the Vcpkg support, we will see the following.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/ns-3-dev$ ./ns3 clean</span>
<span class="go">/ns-3-dev$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">Cloning into &#39;vcpkg&#39;...</span>
<span class="go">Updating files: 100% (10434/10434), done.</span>
<span class="go">Downloading vcpkg-glibc...</span>
<span class="go">vcpkg package management program version 2023-08-02-6d13efa755f9b5e101712d210199e4139b4c29f6</span>

<span class="go">See LICENSE.txt for license information.</span>
<span class="go">-- vcpkg: detected a vcpkg manifest file: /ns-3-dev/vcpkg.json</span>
<span class="go">A suitable version of cmake was not found (required v3.27.1) Downloading portable cmake 3.27.1...</span>
<span class="go">Downloading cmake...</span>
<span class="go">https://github.com/Kitware/CMake/releases/download/v3.27.1/cmake-3.27.1-linux-x86_64.tar.gz-&gt;/ns-3-dev/vcpkg/downloads/cmake-3.27.1-linux-x86_64.tar.gz</span>
<span class="go">Extracting cmake...</span>
<span class="go">Detecting compiler hash for triplet x64-linux...</span>
<span class="go">The following packages will be built and installed:</span>
<span class="go">  * boost-array:x64-linux -&gt; 1.82.0#2</span>
<span class="go">  ...</span>
<span class="go">  * boost-winapi:x64-linux -&gt; 1.82.0#2</span>
<span class="go">    eigen3:x64-linux -&gt; 3.4.0#2</span>
<span class="go">    gsl:x64-linux -&gt; 2.7.1#3</span>
<span class="go">  * libiconv:x64-linux -&gt; 1.17#1</span>
<span class="go">  * liblzma:x64-linux -&gt; 5.4.3#1</span>
<span class="go">    libxml2[core,iconv,lzma,zlib]:x64-linux -&gt; 2.10.3#1</span>
<span class="go">    sqlite3[core,json1]:x64-linux -&gt; 3.42.0#1</span>
<span class="go">  * vcpkg-cmake:x64-linux -&gt; 2023-05-04</span>
<span class="go">  * vcpkg-cmake-config:x64-linux -&gt; 2022-02-06#1</span>
<span class="go">  * vcpkg-cmake-get-vars:x64-linux -&gt; 2023-03-02</span>
<span class="go">  * zlib:x64-linux -&gt; 1.2.13</span>
<span class="go">Additional packages (*) will be modified to complete this operation.</span>
<span class="go">Restored 0 package(s) from /root/.cache/vcpkg/archives in 98.7 us. Use --debug to see more details.</span>
<span class="go">Installing 1/58 boost-uninstall:x64-linux...</span>
<span class="go">...</span>
<span class="go">Installing 50/58 boost-units:x64-linux...</span>
<span class="go">Building boost-units:x64-linux...</span>
<span class="go">-- Downloading https://github.com/boostorg/units/archive/boost-1.82.0.tar.gz -&gt; boostorg-units-boost-1.82.0.tar.gz...</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/boostorg-units-boost-1.82.0.tar.gz</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/boost-units/src/ost-1.82.0-a9fdcc40b2.clean</span>
<span class="go">-- Copying headers</span>
<span class="go">-- Copying headers done</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/boost-units_x64-linux/share/boost-units/usage</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/boost-units_x64-linux/share/boost-units/copyright</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 276 ms.</span>
<span class="go">Elapsed time to handle boost-units:x64-linux: 3.8 s</span>
<span class="go">Installing 51/58 vcpkg-cmake-config:x64-linux...</span>
<span class="go">Building vcpkg-cmake-config:x64-linux...</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/vcpkg-cmake-config_x64-linux/share/vcpkg-cmake-config/vcpkg_cmake_config_fixup.cmake</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/vcpkg-cmake-config_x64-linux/share/vcpkg-cmake-config/vcpkg-port-config.cmake</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/vcpkg-cmake-config_x64-linux/share/vcpkg-cmake-config/copyright</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 8.58 ms.</span>
<span class="go">Elapsed time to handle vcpkg-cmake-config:x64-linux: 144 ms</span>
<span class="go">Installing 52/58 eigen3:x64-linux...</span>
<span class="go">Building eigen3:x64-linux...</span>
<span class="go">-- Downloading https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.gz -&gt; libeigen-eigen-3.4.0.tar.gz...</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/libeigen-eigen-3.4.0.tar.gz</span>
<span class="go">-- Applying patch remove_configure_checks.patch</span>
<span class="go">-- Applying patch fix-vectorized-reductions-half.patch</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/eigen3/src/3.4.0-74a8d62212.clean</span>
<span class="go">-- Configuring x64-linux</span>
<span class="go">-- Building x64-linux-dbg</span>
<span class="go">-- Building x64-linux-rel</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/lib/pkgconfig/eigen3.pc</span>
<span class="go">CMake Error at scripts/cmake/vcpkg_find_acquire_program.cmake:163 (message):</span>
<span class="go">  Could not find pkg-config.  Please install it via your package manager:</span>

<span class="go">      sudo apt-get install pkg-config</span>
<span class="go">Call Stack (most recent call first):</span>
<span class="go">  scripts/cmake/vcpkg_fixup_pkgconfig.cmake:203 (vcpkg_find_acquire_program)</span>
<span class="go">  ports/eigen3/portfile.cmake:30 (vcpkg_fixup_pkgconfig)</span>
<span class="go">  scripts/ports.cmake:147 (include)</span>


<span class="go">error: building eigen3:x64-linux failed with: BUILD_FAILED</span>
<span class="go">Elapsed time to handle eigen3:x64-linux: 19 s</span>
<span class="go">Please ensure you&#39;re using the latest port files with `git pull` and `vcpkg update`.</span>
<span class="go">Then check for known issues at:</span>
<span class="go">    https://github.com/microsoft/vcpkg/issues?q=is%3Aissue+is%3Aopen+in%3Atitle+eigen3</span>
<span class="go">You can submit a new issue at:</span>
<span class="go">    https://github.com/microsoft/vcpkg/issues/new?title=[eigen3]+Build+error&amp;body=Copy+issue+body+from+%2Fns-3-dev%2Fvcpkg%2Finstalled%2Fvcpkg%2Fissue_body.md</span>

<span class="go">CMake Error at build-support/3rd-party/colored-messages.cmake:82 (_message):</span>
<span class="go">  vcpkg: packages defined in the manifest failed to be installed</span>
<span class="go">Call Stack (most recent call first):</span>
<span class="go">  build-support/custom-modules/ns3-vcpkg-hunter.cmake:138 (message)</span>
<span class="go">  build-support/custom-modules/ns3-vcpkg-hunter.cmake:183 (setup_vcpkg)</span>
<span class="go">  build-support/macros-and-definitions.cmake:743 (include)</span>
<span class="go">  CMakeLists.txt:149 (process_options)</span>
</pre></div>
</div>
<p>As we can see above, the setup failed during the eigen3 setup due to a missing dependency.
In this case, pkg-config. We can install it using the system package manager and then
resume the ns-3 configuration.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/ns-3-dev$ apt install -y pkg-config</span>
<span class="go">/ns-3-dev$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: folder already exists, skipping git download</span>
<span class="go">-- vcpkg: already bootstrapped</span>
<span class="go">-- vcpkg: detected a vcpkg manifest file: /ns-3-dev/vcpkg.json</span>
<span class="go">Detecting compiler hash for triplet x64-linux...</span>
<span class="go">The following packages will be built and installed:</span>
<span class="go">    eigen3:x64-linux -&gt; 3.4.0#2</span>
<span class="go">    gsl:x64-linux -&gt; 2.7.1#3</span>
<span class="go">  * libiconv:x64-linux -&gt; 1.17#1</span>
<span class="go">  * liblzma:x64-linux -&gt; 5.4.3#1</span>
<span class="go">    libxml2[core,iconv,lzma,zlib]:x64-linux -&gt; 2.10.3#1</span>
<span class="go">    sqlite3[core,json1]:x64-linux -&gt; 3.42.0#1</span>
<span class="go">  * zlib:x64-linux -&gt; 1.2.13</span>
<span class="go">Additional packages (*) will be modified to complete this operation.</span>
<span class="go">Restored 0 package(s) from /root/.cache/vcpkg/archives in 97.6 us. Use --debug to see more details.</span>
<span class="go">Installing 1/7 eigen3:x64-linux...</span>
<span class="go">Building eigen3:x64-linux...</span>
<span class="go">-- Using cached libeigen-eigen-3.4.0.tar.gz.</span>
<span class="go">-- Cleaning sources at /ns-3-dev/vcpkg/buildtrees/eigen3/src/3.4.0-74a8d62212.clean. Use --editable to skip cleaning for the packages you specify.</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/libeigen-eigen-3.4.0.tar.gz</span>
<span class="go">-- Applying patch remove_configure_checks.patch</span>
<span class="go">-- Applying patch fix-vectorized-reductions-half.patch</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/eigen3/src/3.4.0-74a8d62212.clean</span>
<span class="go">-- Configuring x64-linux</span>
<span class="go">-- Building x64-linux-dbg</span>
<span class="go">-- Building x64-linux-rel</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/lib/pkgconfig/eigen3.pc</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/debug/lib/pkgconfig/eigen3.pc</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/share/eigen3/copyright</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 1.7 s.</span>
<span class="go">Elapsed time to handle eigen3:x64-linux: 28 s</span>
<span class="go">Installing 2/7 gsl:x64-linux...</span>
<span class="go">...</span>
<span class="go">Installing 7/7 sqlite3:x64-linux...</span>
<span class="go">Building sqlite3[core,json1]:x64-linux...</span>
<span class="go">-- Downloading https://sqlite.org/2023/sqlite-amalgamation-3420000.zip -&gt; sqlite-amalgamation-3420000.zip...</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/sqlite-amalgamation-3420000.zip</span>
<span class="go">-- Applying patch fix-arm-uwp.patch</span>
<span class="go">-- Applying patch add-config-include.patch</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/sqlite3/src/on-3420000-e624a7f335.clean</span>
<span class="go">-- Configuring x64-linux</span>
<span class="go">-- Building x64-linux-dbg</span>
<span class="go">-- Building x64-linux-rel</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/sqlite3_x64-linux/lib/pkgconfig/sqlite3.pc</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/sqlite3_x64-linux/debug/lib/pkgconfig/sqlite3.pc</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/sqlite3_x64-linux/share/sqlite3/usage</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 430 ms.</span>
<span class="go">Elapsed time to handle sqlite3:x64-linux: 42 s</span>
<span class="go">Total install time: 2.5 min</span>
<span class="go">The package boost is compatible with built-in CMake targets:</span>

<span class="go">    find_package(Boost REQUIRED [COMPONENTS &lt;libs&gt;...])</span>
<span class="go">    target_link_libraries(main PRIVATE Boost::boost Boost::&lt;lib1&gt; Boost::&lt;lib2&gt; ...)</span>

<span class="go">eigen3 provides CMake targets:</span>

<span class="gp">    # </span>this<span class="w"> </span>is<span class="w"> </span>heuristically<span class="w"> </span>generated,<span class="w"> </span>and<span class="w"> </span>may<span class="w"> </span>not<span class="w"> </span>be<span class="w"> </span>correct
<span class="go">    find_package(Eigen3 CONFIG REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE Eigen3::Eigen)</span>

<span class="go">The package gsl is compatible with built-in CMake targets:</span>

<span class="go">    find_package(GSL REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE GSL::gsl GSL::gslcblas)</span>

<span class="go">The package libxml2 is compatible with built-in CMake targets:</span>

<span class="go">    find_package(LibXml2 REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE LibXml2::LibXml2)</span>

<span class="go">sqlite3 provides pkgconfig bindings.</span>
<span class="go">sqlite3 provides CMake targets:</span>

<span class="go">    find_package(unofficial-sqlite3 CONFIG REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE unofficial::sqlite3::sqlite3)</span>

<span class="go">-- vcpkg: packages defined in the manifest were installed</span>
<span class="go">-- find_external_library: SQLite3 was found.</span>
<span class="go">...</span>
<span class="go">-- LibXML2 was found.</span>
<span class="go">...</span>
<span class="go">-- Found Boost: /ns-3-dev/vcpkg/installed/x64-linux/include (found version &quot;1.82.0&quot;)</span>
<span class="go">...</span>
<span class="go">-- Looking for include files boost/units/quantity.hpp, boost/units/systems/si.hpp</span>
<span class="go">-- Looking for include files boost/units/quantity.hpp, boost/units/systems/si.hpp - found</span>
<span class="go">-- Boost Units have been found.</span>
<span class="go">...</span>
<span class="go">-- ---- Summary of ns-3 settings:</span>
<span class="go">Build profile                 : default</span>
<span class="go">Build directory               : /ns-3-dev/build</span>
<span class="go">Build with runtime asserts    : ON</span>
<span class="go">...</span>
<span class="go">GNU Scientific Library (GSL)  : ON</span>
<span class="go">...</span>
<span class="go">LibXml2 support               : ON</span>
<span class="go">...</span>
<span class="go">SQLite support                : ON</span>
<span class="go">Eigen3 support                : ON</span>
<span class="go">...</span>
</pre></div>
</div>
<p>From the above, we can see that the headers and libraries installed by the packages
were correctly found by CMake and the optional features were successfully enabled.</p>
<p>Note: not every vcpkg package (also known as a port) obeys
the same pattern for usage. The user of the package needs
to look into the usage file of said port for instructions.
In the case of Armadillo, the corresponding file can be found
in <a class="reference external" href="https://github.com/microsoft/vcpkg/blob/master/ports/armadillo/usage">Armadillo’s port on vcpkg</a>.</p>
<p>Vcpkg is installed to a <code class="docutils literal notranslate"><span class="pre">vcpkg</span></code> directory inside the ns-3 main directory (e.g. <code class="docutils literal notranslate"><span class="pre">ns-3-dev</span></code>).
Packages installed via vcpkg are installed to <code class="docutils literal notranslate"><span class="pre">ns-3-dev/vcpkg/installed/${VCPKG_TRIPLET}</span></code>,
which is automatically added to the <code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code>, making headers, libraries, and
pkg-config and CMake packages discoverable via <code class="docutils literal notranslate"><span class="pre">find_file</span></code>, <code class="docutils literal notranslate"><span class="pre">find_library</span></code>, <code class="docutils literal notranslate"><span class="pre">find_package</span></code>
and <code class="docutils literal notranslate"><span class="pre">pkg_check_modules</span></code>.</p>
</section>
<section id="id7">
<h4><span class="section-number">4.3.7.5.2. </span>CPM<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h4>
<p><a class="reference external" href="https://github.com/cpm-cmake/CPM.cmake">CPM</a> is a package manager made for CMake projects consuming CMake projects.
Some CMake projects however, create files during the installation step, which
is not supported by CPM, which treats the package as a CMake subproject that
we can then depend upon. CPM may require dependencies such as <code class="docutils literal notranslate"><span class="pre">git</span></code> and <code class="docutils literal notranslate"><span class="pre">tar</span></code>,
depending on the package sources used.</p>
<p>Let’s see an example trying to find the Armadillo library via CMake.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Check this is not a fluke</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Reconfigure ns-3 to check if Armadillo is available.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 configure</span>
<span class="go">...</span>
<span class="go">-- Could NOT find Armadillo (missing: ARMADILLO_INCLUDE_DIR)</span>
<span class="go">-- Armadillo was found? FALSE</span>
</pre></div>
</div>
<p>As you can see, no Armadillo found.
We can now use CPM to install it, using the CMake
function <code class="docutils literal notranslate"><span class="pre">CPMAddPackage(package_info)</span></code>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo and search for it again</span>
<span class="nb">CPMAddPackage</span><span class="p">(</span>
<span class="w">    </span><span class="s">NAME</span><span class="w"> </span><span class="s">ARMADILLO</span>
<span class="w">    </span><span class="s">GIT_TAG</span><span class="w"> </span><span class="s">6cada351248c9a967b137b9fcb3d160dad7c709b</span>
<span class="w">    </span><span class="s">GIT_REPOSITORY</span><span class="w"> </span><span class="s">https://gitlab.com/conradsnicta/armadillo-code.git</span>
<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads CPM installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Sadly, we will need to reconfigure ns-3 from the scratch,
since CMake <code class="docutils literal notranslate"><span class="pre">find_package</span></code> caches are problematic.
Installing the packages can take a while, and it can look like it hanged.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 clean</span>
<span class="go">~$ ./ns3 configure -- -DNS3_CPM=ON</span>
<span class="go">...</span>
<span class="go">-- CPM: Adding package ARMADILLO@0 (6cada351248c9a967b137b9fcb3d160dad7c709b)</span>
<span class="go">-- *** set cmake policy CMP0025 to NEW</span>
<span class="go">-- CMAKE_CXX_STANDARD = 11</span>
<span class="go">-- Configuring Armadillo 12.6.1</span>
<span class="go">--</span>
<span class="go">-- *** WARNING: variable &#39;CMAKE_CXX_FLAGS&#39; is not empty; this may cause problems!</span>
<span class="go">--</span>
<span class="go">-- Detected Clang 6.0 or newer</span>
<span class="go">-- ARMA_USE_EXTERN_RNG = true</span>
<span class="go">-- CMAKE_SYSTEM_NAME          = Linux</span>
<span class="go">-- CMAKE_CXX_COMPILER_ID      = Clang</span>
<span class="go">-- CMAKE_CXX_COMPILER_VERSION = 15.0.7</span>
<span class="go">-- CMAKE_COMPILER_IS_GNUCXX   =</span>
<span class="go">--</span>
<span class="go">-- *** Options:</span>
<span class="go">-- BUILD_SHARED_LIBS         = ON</span>
<span class="go">-- OPENBLAS_PROVIDES_LAPACK  = OFF</span>
<span class="go">-- ALLOW_FLEXIBLAS_LINUX     = ON</span>
<span class="go">-- ALLOW_OPENBLAS_MACOS      = OFF</span>
<span class="go">-- ALLOW_BLAS_LAPACK_MACOS   = OFF</span>
<span class="go">-- BUILD_SMOKE_TEST          = ON</span>
<span class="go">--</span>
<span class="go">-- *** Looking for external libraries</span>
<span class="go">-- Found OpenBLAS: /usr/lib/x86_64-linux-gnu/libopenblas.so</span>
<span class="go">-- Found BLAS: /usr/lib/x86_64-linux-gnu/libblas.so</span>
<span class="go">-- Found LAPACK: /usr/lib/x86_64-linux-gnu/liblapack.so</span>
<span class="go">-- FlexiBLAS_FOUND = NO</span>
<span class="go">--       MKL_FOUND = NO</span>
<span class="go">--  OpenBLAS_FOUND = YES</span>
<span class="go">--     ATLAS_FOUND = NO</span>
<span class="go">--      BLAS_FOUND = YES</span>
<span class="go">--    LAPACK_FOUND = YES</span>
<span class="go">--</span>
<span class="go">-- *** NOTE: found both OpenBLAS and BLAS; BLAS will not be used</span>
<span class="go">--</span>
<span class="go">-- *** NOTE: if OpenBLAS is known to provide LAPACK functions, recommend to</span>
<span class="go">-- *** NOTE: rerun cmake with the OPENBLAS_PROVIDES_LAPACK option enabled:</span>
<span class="go">-- *** NOTE: cmake -D OPENBLAS_PROVIDES_LAPACK=true .</span>
<span class="go">--</span>
<span class="go">-- *** If the OpenBLAS library is installed in</span>
<span class="go">-- *** /usr/local/lib or /usr/local/lib64</span>
<span class="go">-- *** make sure the run-time linker can find it.</span>
<span class="go">-- *** On Linux systems this can be done by editing /etc/ld.so.conf</span>
<span class="go">-- *** or modifying the LD_LIBRARY_PATH environment variable.</span>
<span class="go">--</span>
<span class="go">-- Found ARPACK: /usr/lib/x86_64-linux-gnu/libarpack.so</span>
<span class="go">-- ARPACK_FOUND = YES</span>
<span class="go">-- Looking for SuperLU version 5</span>
<span class="go">-- Found SuperLU: /usr/lib/x86_64-linux-gnu/libsuperlu.so</span>
<span class="go">-- SuperLU_FOUND = YES</span>
<span class="go">-- SuperLU_INCLUDE_DIR = /usr/include/superlu</span>
<span class="go">--</span>
<span class="go">-- *** Result of configuration:</span>
<span class="go">-- *** ARMA_USE_WRAPPER    = true</span>
<span class="go">-- *** ARMA_USE_LAPACK     = true</span>
<span class="go">-- *** ARMA_USE_BLAS       = true</span>
<span class="go">-- *** ARMA_USE_ATLAS      = false</span>
<span class="go">-- *** ARMA_USE_ARPACK     = true</span>
<span class="go">-- *** ARMA_USE_EXTERN_RNG = true</span>
<span class="go">-- *** ARMA_USE_SUPERLU    = true</span>
<span class="go">--</span>
<span class="go">-- *** Armadillo wrapper library will use the following libraries:</span>
<span class="go">-- *** ARMA_LIBS = /usr/lib/x86_64-linux-gnu/libopenblas.so;/usr/lib/x86_64-linux-gnu/liblapack.so;/usr/lib/x86_64-linux-gnu/libarpack.so;/usr/lib/x86_64-linux-gnu/libsuperlu.so</span>
<span class="go">--</span>
<span class="go">-- Copying /ns-3-dev/cmake-build-release/_deps/armadillo-src/include/ to /ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/include/</span>
<span class="go">-- Generating /ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/include/config.hpp</span>
<span class="go">-- CMAKE_CXX_FLAGS           =  -fsanitize=address,leak,undefined -O2</span>
<span class="go">-- CMAKE_SHARED_LINKER_FLAGS =  -Wl,--no-as-needed</span>
<span class="go">-- CMAKE_REQUIRED_INCLUDES   = /usr/include;/usr/include/superlu</span>
<span class="go">--</span>
<span class="go">-- CMAKE_INSTALL_PREFIX     = /usr</span>
<span class="go">-- CMAKE_INSTALL_LIBDIR     = lib/x86_64-linux-gnu</span>
<span class="go">-- CMAKE_INSTALL_INCLUDEDIR = include</span>
<span class="go">-- CMAKE_INSTALL_DATADIR    = share</span>
<span class="go">-- CMAKE_INSTALL_BINDIR     = bin</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/ArmadilloConfig.cmake&#39;</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/ArmadilloConfigVersion.cmake&#39;</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/InstallFiles/ArmadilloConfig.cmake&#39;</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/InstallFiles/ArmadilloConfigVersion.cmake&#39;</span>
<span class="go">-- Copying /ns-3-dev/cmake-build-release/_deps/armadillo-src/misc/ to /ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/misc/</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/misc/armadillo.pc&#39;</span>
<span class="go">-- *** configuring smoke_test</span>
<span class="go">-- Armadillo was found? TRUE</span>
<span class="go">...</span>
</pre></div>
</div>
<p>As shown above, the Armadillo library gets installed by CPM
and it can be found by CMake’s <code class="docutils literal notranslate"><span class="pre">find_package</span></code> function.
Differently from other packages found via <code class="docutils literal notranslate"><span class="pre">find_package</span></code>,
CPM creates native CMake targets from the subprojects.
In the case of Armadillo, the target is called <code class="docutils literal notranslate"><span class="pre">armadillo</span></code>,
which we can link to our targets.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo</span>
<span class="nb">CPMAddPackage</span><span class="p">(</span>
<span class="w">    </span><span class="s">NAME</span><span class="w"> </span><span class="s">ARMADILLO</span>
<span class="w">    </span><span class="s">GIT_TAG</span><span class="w"> </span><span class="s">6cada351248c9a967b137b9fcb3d160dad7c709b</span>
<span class="w">    </span><span class="s">GIT_REPOSITORY</span><span class="w"> </span><span class="s">https://gitlab.com/conradsnicta/armadillo-code.git</span>
<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads CPM installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>

<span class="c"># CPM is kind of jenky. It could get the ARMADILLO_INCLUDE_DIRS</span>
<span class="c"># from the ArmadilloConfig.cmake file in ${CMAKE_BINARY_DIR}/_deps/armadillo-build,</span>
<span class="c"># but it doesn&#39;t... So add its include directories directly from the source directory</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="o">}</span><span class="s">/_deps/armadillo-src/include</span><span class="p">)</span>

<span class="c"># Link to Armadillo and</span>
<span class="nb">link_libraries</span><span class="p">(</span><span class="s">armadillo</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: using CPM can be challenging. Users are recommended
to look at <a class="reference external" href="https://github.com/cpm-cmake/CPM.cmake/wiki/More-Snippets">CPM’s examples</a>.</p>
<p>For example, the libraries of installed packages will be placed by default in
the <code class="docutils literal notranslate"><span class="pre">ns-3-dev/build/lib</span></code> directory. On the other hand, header placement depends
on how the CMake project was setup.</p>
<p>If the package CMakeLists.txt was made to build in-source, headers will be
along the source files, which will be placed in
<code class="docutils literal notranslate"><span class="pre">${PROJECT_BINARY_DIR}/_deps/packageName-src</span></code>. When configured with the
ns3 script, <code class="docutils literal notranslate"><span class="pre">PROJECT_BINARY_DIR</span> <span class="pre">corresponds</span></code> to <code class="docutils literal notranslate"><span class="pre">ns-3-dev/cmake-cache</span></code>.</p>
<p>If the package CMakeLists.txt copies the headers to an output directory
(like ns-3 does), it will be placed in
<code class="docutils literal notranslate"><span class="pre">${PROJECT_BINARY_DIR}/_deps/packageName-build</span></code>,
possibly in an <code class="docutils literal notranslate"><span class="pre">include</span></code> subdirectory.</p>
<p>In case it was configured to copy the headers to <code class="docutils literal notranslate"><span class="pre">${CMAKE_BINARY_DIR}/include</span></code>,
the headers will land on <code class="docutils literal notranslate"><span class="pre">${PROJECT_BINARY_DIR}/include</span></code> of the most top-level
project. In our case, the top-level project is the NS3 project.</p>
<p>Since the packages get installed into the ns-3 cache directory
(<code class="docutils literal notranslate"><span class="pre">PROJECT_BINARY_DIR</span></code>), using <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">clean</span></code> will delete them,
requiring them to be rebuilt.</p>
</section>
</section>
<section id="inclusion-of-options">
<h3><span class="section-number">4.3.7.6. </span>Inclusion of options<a class="headerlink" href="#inclusion-of-options" title="Link to this heading">¶</a></h3>
<p>There are two ways of managing module options: option switches or cached variables.
Both are present in the main CMakeLists.txt in the ns-3-dev directory and the
build-support/macros-and-definitions.cmake file.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Here are examples of ON and OFF switches</span>
<span class="c"># option(</span>
<span class="c">#        NS3_SWITCH # option switch prefixed with NS3\_</span>
<span class="c">#        &quot;followed by the description of what the option does&quot;</span>
<span class="c">#        ON # and the default value for that option</span>
<span class="c">#        )</span>
<span class="nb">option</span><span class="p">(</span><span class="s">NS3_EXAMPLES</span><span class="w"> </span><span class="s2">&quot;Enable examples to be built&quot;</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="nb">option</span><span class="p">(</span><span class="s">NS3_TESTS</span><span class="w"> </span><span class="s2">&quot;Enable tests to be built&quot;</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Now here is how to let the user indicate a path</span>
<span class="c"># set( # declares a value</span>
<span class="c">#     NS3_PREFIXED_VALUE # stores the option value</span>
<span class="c">#     &quot;&quot; # default value is empty in this case</span>
<span class="c">#     CACHE # stores that NS3_PREFIXED_VALUE in the CMakeCache.txt file</span>
<span class="c">#     STRING # type of the cached variable</span>
<span class="c">#     &quot;description of what this value is used for&quot;</span>
<span class="c">#     )</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_OUTPUT_DIRECTORY</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">PATH</span><span class="w"> </span><span class="s2">&quot;Directory to store built artifacts&quot;</span><span class="p">)</span>

<span class="c"># The last case are options that can only assume predefined values</span>
<span class="c"># First we cache the default option</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_INT64X64</span><span class="w"> </span><span class="s2">&quot;INT128&quot;</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">STRING</span><span class="w"> </span><span class="s2">&quot;Int64x64 implementation&quot;</span><span class="p">)</span>

<span class="c"># Then set a cache property for the variable indicating it can assume</span>
<span class="c"># specific values</span>
<span class="nb">set_property</span><span class="p">(</span><span class="s">CACHE</span><span class="w"> </span><span class="s">NS3_INT64X64</span><span class="w"> </span><span class="s">PROPERTY</span><span class="w"> </span><span class="s">STRINGS</span><span class="w"> </span><span class="s">INT128</span><span class="w"> </span><span class="s">CAIRO</span><span class="w"> </span><span class="s">DOUBLE</span><span class="p">)</span>
</pre></div>
</div>
<p>More details about these commands can be found in the following links:
<a class="reference external" href="https://cmake.org/cmake/help/latest/command/option.html">option</a>, <a class="reference external" href="https://cmake.org/cmake/help/latest/command/set.html">set</a>, <a class="reference external" href="https://cmake.org/cmake/help/latest/command/set_property.html">set_property</a>.</p>
</section>
<section id="changes-in-cmake-macros-and-functions">
<h3><span class="section-number">4.3.7.7. </span>Changes in CMake macros and functions<a class="headerlink" href="#changes-in-cmake-macros-and-functions" title="Link to this heading">¶</a></h3>
<p>In order for CMake to feel more familiar to Waf users, a few macros and functions
were created.</p>
<p>The most frequently used macros them can be found in
<code class="docutils literal notranslate"><span class="pre">build-support/macros-and-definitions.cmake</span></code>. This file includes build type checking,
compiler family and version checking, enabling and disabling features based
on user options, checking for dependencies of enabled features,
pre-compiling headers, filtering enabled/disabled modules and dependencies,
and more.</p>
<section id="executable-macros">
<h4><span class="section-number">4.3.7.7.1. </span>Executable macros<a class="headerlink" href="#executable-macros" title="Link to this heading">¶</a></h4>
<p>Creating an executable in CMake requires a few different macro calls.
Some of these calls are related to setting the target and built executable name,
indicating which libraries that should be linked to the executable,
where the executable should be placed after being built and installed.</p>
<p>Note that if you are trying to add a new example to your module, you should
look at the <a class="reference internal" href="#build-lib-example">build_lib_example</a> macro section.</p>
<p>If you are trying to add a new example to <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/examples</span></code>, you should
look at the <a class="reference internal" href="#build-example">build_example</a> macro section.</p>
<p>While both of the previously mentioned macros are meant to be used for examples,
in some cases additional utilities are required. Those utilities can be helpers,
such as the <code class="docutils literal notranslate"><span class="pre">raw-sock-creator</span></code> in the <code class="docutils literal notranslate"><span class="pre">fd-net-device</span></code> module, or benchmark
tools in the <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/utils</span></code> directory. In those cases, the <a class="reference internal" href="#build-exec">build_exec</a>
macro is recommended instead of direct CMake calls.</p>
<section id="executable-macros-build-exec">
<span id="build-exec"></span><h5><span class="section-number">4.3.7.7.1.1. </span>Executable macros: build_exec<a class="headerlink" href="#executable-macros-build-exec" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">build_exec</span></code> macro bundles a series of direct CMake calls into a single macro.
The example below shows the creation of an executable named <code class="docutils literal notranslate"><span class="pre">example</span></code>, that will
later receive a version prefix (e.g. <code class="docutils literal notranslate"><span class="pre">ns3.37-</span></code>) and a build type suffix
(e.g. <code class="docutils literal notranslate"><span class="pre">-debug</span></code>), resulting in an executable file named <code class="docutils literal notranslate"><span class="pre">ns3.37-example-debug</span></code>.</p>
<p>The list of source and header files can be passed in the <code class="docutils literal notranslate"><span class="pre">SOURCE_FILES</span></code> and
<code class="docutils literal notranslate"><span class="pre">HEADER_FILES</span></code> arguments, followed by the <code class="docutils literal notranslate"><span class="pre">LIBRARIES_TO_LINK</span></code> that will be linked
to the executable.</p>
<p>That executable will be saved by default to the <code class="docutils literal notranslate"><span class="pre">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span></code>
(e.g. /ns-3-dev/build/bin). To change its destination, set <code class="docutils literal notranslate"><span class="pre">EXECUTABLE_DIRECTORY_PATH</span></code>
to the desired path. The path is relative to the <code class="docutils literal notranslate"><span class="pre">CMAKE_OUTPUT_DIRECTORY</span></code>
(e.g. /ns-3-dev/build).</p>
<p>In case this executable should be installed, set <code class="docutils literal notranslate"><span class="pre">INSTALL_DIRECTORY_PATH</span></code> to the
desired destination. In case this value is empty, the executable will not be installed.
The path is relative to the <code class="docutils literal notranslate"><span class="pre">CMAKE_INSTALL_PREFIX</span></code> (e.g. /usr).</p>
<p>To set custom compiler defines for that specific executable, defines can be passed
to the <code class="docutils literal notranslate"><span class="pre">DEFINITIONS</span></code> argument.</p>
<p>Add the <code class="docutils literal notranslate"><span class="pre">STANDALONE</span></code> option to prevent linking the <em>ns-3</em> static library
(<code class="docutils literal notranslate"><span class="pre">NS3_STATIC</span></code>) and single shared library (<code class="docutils literal notranslate"><span class="pre">NS3_MONOLIB</span></code>) to the executable.
This may be necessary in case the executable redefine symbols which are part
of the <em>ns-3</em> library. This is the case for the fd-net-device creators and the tap-creator,
which include the source file <code class="docutils literal notranslate"><span class="pre">encode-decode.cc</span></code>, which is also part of fd-net-device module
and tap-bridge module, respectively.</p>
<p>Finally, to ignore precompiled headers, include <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> to the list of parameters.
You can find more information about <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> at the <a class="reference internal" href="#pch-side-effects">PCH side-effects</a> section.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_exec</span><span class="p">(</span>
<span class="w">  </span><span class="c"># necessary</span>
<span class="w">  </span><span class="s">EXECNAME</span><span class="w"> </span><span class="s">example</span><span class="w">                       </span><span class="c"># executable name = example (plus version prefix and build type suffix)</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">example.cc</span><span class="w"> </span><span class="s">example-complement.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">example.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span><span class="w">           </span><span class="c"># links to core</span>
<span class="w">  </span><span class="s">EXECUTABLE_DIRECTORY_PATH</span><span class="w"> </span><span class="s">scratch</span><span class="w">          </span><span class="c"># build/scratch</span>
<span class="w">  </span><span class="c"># optional</span>
<span class="w">  </span><span class="s">EXECNAME_PREFIX</span><span class="w"> </span><span class="s">scratch_subdir_prefix_</span><span class="w"> </span><span class="c"># target name = scratch_subdir_prefix_example</span>
<span class="w">  </span><span class="s">INSTALL_DIRECTORY_PATH</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_BIN</span><span class="o">}</span><span class="s">/</span><span class="w">   </span><span class="c"># e.g. /usr/bin/ns3.37-scratch_subdir_prefix_example-debug</span>
<span class="w">  </span><span class="s">DEFINITIONS</span><span class="w"> </span><span class="s">-DHAVE_FEATURE=1</span><span class="w">           </span><span class="c"># defines for this specific target</span>
<span class="w">  </span><span class="s">[STANDALONE]</span><span class="w">                           </span><span class="c"># set in case you don&#39;t want the executable to be linked to ns3-static/ns3-monolib</span>
<span class="w">  </span><span class="s">IGNORE_PCH</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The same executable can be built by directly calling the following CMake macros:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">target_prefix</span><span class="w"> </span><span class="s">scratch_subdir_prefix_</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">target_name</span><span class="w"> </span><span class="s">example</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">output_directory</span><span class="w"> </span><span class="s">scratch</span><span class="p">)</span>

<span class="c"># Creates a target named &quot;example&quot; (target_name) prefixed with &quot;scratch_subdir_prefix_&quot; (target_prefix)</span>
<span class="c"># e.g. scratch_subdir_prefix_example</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">example.cc</span><span class="w"> </span><span class="s">example-complement.cc</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Create a variable with the target name prefixed with</span>
<span class="c"># the version and suffixed with the build profile suffix</span>
<span class="c"># e.g. ns3.37-scratch_subdir_prefix_example-debug</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3-exec-outputname</span><span class="w"> </span><span class="s">ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}${</span><span class="nv">build_profile_suffix</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Append the binary name to the executables list later written to the lock file,</span>
<span class="c"># which is consumed by the ns3 script and test.py</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3-execs</span><span class="w"> </span><span class="s2">&quot;${output_directory}${ns3-exec-outputname};${ns3-execs}&quot;</span>
<span class="w">   </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of c++ executables&quot;</span>
<span class="p">)</span>
<span class="c"># Modify the target properties to change the binary name to ns3-exec-outputname contents</span>
<span class="c"># and modify its output directory (e.g. scratch). The output directory is relative to the build directory.</span>
<span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">  </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span>
<span class="w">  </span><span class="s">PROPERTIES</span><span class="w"> </span><span class="s">RUNTIME_OUTPUT_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">output_directory</span><span class="o">}</span>
<span class="w">             </span><span class="s">RUNTIME_OUTPUT_NAME</span><span class="w"> </span><span class="o">${</span><span class="nv">ns3-exec-outputname</span><span class="o">}</span>
<span class="p">)</span>
<span class="c"># Create a dependency between the target and the all-test-targets</span>
<span class="c"># (used by ctest, coverage and doxygen targets)</span>
<span class="nb">add_dependencies</span><span class="p">(</span><span class="s">all-test-targets</span><span class="w"> </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Create a dependency between the target and the timeTraceReport</span>
<span class="c"># (used by Clang TimeTrace to collect compilation statistics)</span>
<span class="nb">add_dependencies</span><span class="p">(</span><span class="s">timeTraceReport</span><span class="w"> </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="p">)</span><span class="w"> </span><span class="c"># target used to track compilation time</span>

<span class="c"># Set target-specific compile definitions</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s">definitions</span><span class="p">)</span>

<span class="c"># Check whether the target should reuse or not the precompiled headers</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">target_precompile_headers</span><span class="p">(</span>
<span class="w">          </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch_exec</span>
<span class="w">       </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="executable-macros-build-example">
<span id="build-example"></span><h5><span class="section-number">4.3.7.7.1.2. </span>Executable macros: build_example<a class="headerlink" href="#executable-macros-build-example" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">build_example</span></code> macro sets some of <code class="docutils literal notranslate"><span class="pre">build_exec</span></code>’s arguments based on the current
example directory (output directory) and adds the optional visualizer module as a dependency
in case it is enabled. It also performs dependency checking on the libraries passed.</p>
<p>In case one of the dependencies listed is not found, the example target will not be created.
If you are trying to add an example or a dependency to an existing example and it is not
listed by <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">show</span> <span class="pre">targets</span></code> or your IDE, check if all its dependencies were found.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">macro</span><span class="p">(</span><span class="s">build_example</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">NAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">LIBRARIES_TO_LINK</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Parse arguments</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;EXAMPLE&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Filter examples out if they don&#39;t contain one of the filtered in modules</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="w">    </span><span class="nb">foreach</span><span class="p">(</span><span class="s">filtered_module</span><span class="w"> </span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">filtered_module</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">EXAMPLE_LIBRARIES_TO_LINK</span><span class="p">)</span>
<span class="w">        </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endforeach</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Check if any of the LIBRARIES_TO_LINK is missing to prevent configuration errors</span>
<span class="w">  </span><span class="nb">check_for_missing_libraries</span><span class="p">(</span>
<span class="w">    </span><span class="s">missing_dependencies</span><span class="w"> </span><span class="s2">&quot;${EXAMPLE_LIBRARIES_TO_LINK}&quot;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="nb">if</span><span class="p">((</span><span class="s">NOT</span><span class="w"> </span><span class="s">missing_dependencies</span><span class="p">)</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">filtered_in</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Convert boolean into text to forward argument</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">EXAMPLE_IGNORE_PCH</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">IGNORE_PCH</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="c"># Create example library with sources and headers</span>
<span class="w">    </span><span class="c"># cmake-format: off</span>
<span class="w">    </span><span class="nb">build_exec</span><span class="p">(</span>
<span class="w">      </span><span class="s">EXECNAME</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_NAME</span><span class="o">}</span>
<span class="w">      </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_SOURCE_FILES</span><span class="o">}</span>
<span class="w">      </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_HEADER_FILES</span><span class="o">}</span>
<span class="w">      </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_LIBRARIES_TO_LINK</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns3-optional-visualizer-lib</span><span class="o">}</span>
<span class="w">      </span><span class="s">EXECUTABLE_DIRECTORY_PATH</span>
<span class="w">        </span><span class="o">${</span><span class="nv">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/examples/</span><span class="o">${</span><span class="nv">examplefolder</span><span class="o">}</span><span class="s">/</span>
<span class="w">      </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="c"># cmake-format: on</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endmacro</span><span class="p">()</span>
</pre></div>
</div>
<p>An example on how it is used can be found in <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/examples/tutorial/CMakeLists.txt</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_example</span><span class="p">(</span>
<span class="w">  </span><span class="s">NAME</span><span class="w"> </span><span class="s">first</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">first.cc</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libpoint-to-point</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libapplications</span><span class="o">}</span>
<span class="w">    </span><span class="c"># If visualizer is available, the macro will add the module to this list automatically</span>
<span class="w">  </span><span class="c"># build_exec&#39;s EXECUTABLE_DIRECTORY_PATH will be set to build/examples/tutorial/</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="module-macros">
<h4><span class="section-number">4.3.7.7.2. </span>Module macros<a class="headerlink" href="#module-macros" title="Link to this heading">¶</a></h4>
<p>Module macros are located in <code class="docutils literal notranslate"><span class="pre">build-support/custom-modules/ns3-module-macros.cmake</span></code>.
This file contains macros defining a library (<code class="docutils literal notranslate"><span class="pre">build_lib</span></code>), the associated test library,
examples (<code class="docutils literal notranslate"><span class="pre">build_lib_example</span></code>) and more. It also contains the macro that builds the
module header (<code class="docutils literal notranslate"><span class="pre">write_module_header</span></code>) that includes all headers from the module
for user scripts.</p>
<p>These macros are responsible for easing the porting of modules from Waf to CMake.</p>
<section id="module-macros-build-lib">
<span id="build-lib"></span><h5><span class="section-number">4.3.7.7.2.1. </span>Module macros: build_lib<a class="headerlink" href="#module-macros-build-lib" title="Link to this heading">¶</a></h5>
<p>As <code class="docutils literal notranslate"><span class="pre">build_lib</span></code> is the most important of the macros, we detail what it does here,
block by block.</p>
<p>The first block declares the arguments received by the macro (in CMake, the
only difference is that a function has its own scope). Notice that there are
different types of arguments. Options that can only be set to ON/OFF.
Options are <code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default, and are set to <code class="docutils literal notranslate"><span class="pre">ON</span></code> if the option name is added to
the arguments list (e.g. <code class="docutils literal notranslate"><span class="pre">build_lib(...</span> <span class="pre">IGNORE_PCH)</span></code>).</p>
<p>Note: You can find more information about <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> at the <a class="reference internal" href="#pch-side-effects">PCH side-effects</a> section.</p>
<p>One value arguments that receive a single value
(usually a string) and in this case used to receive the module name (<code class="docutils literal notranslate"><span class="pre">LIBNAME</span></code>).</p>
<p>Multiple value arguments receive a list of values, which we use to parse lists
of source (for the module itself and for the module tests) and
header files, plus libraries that should be linked and module features.</p>
<p>The call to <code class="docutils literal notranslate"><span class="pre">cmake_parse_arguments</span></code> will parse <code class="docutils literal notranslate"><span class="pre">${ARGN}</span></code> into these values.
The variables containing the parsing results will be prefixed with <code class="docutils literal notranslate"><span class="pre">BLIB_</span></code>
(e.g. <code class="docutils literal notranslate"><span class="pre">LIBNAME</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">BLIB_LIBNAME</span></code>).</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Argument parsing</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">LIBNAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="s">TEST_SOURCES</span>
<span class="w">                    </span><span class="s">DEPRECATED_HEADER_FILES</span><span class="w"> </span><span class="s">MODULE_ENABLED_FEATURES</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;BLIB&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the following block, we add modules in the src folder to a list
and modules in the contrib folder to a different list.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Get path src/module or contrib/module</span>
<span class="w">  </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">FOLDER</span>
<span class="w">                </span><span class="s2">&quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Add library to a global list of libraries</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${FOLDER}&quot;</span><span class="w"> </span><span class="s">MATCHES</span><span class="w"> </span><span class="s2">&quot;src&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-libs</span><span class="w"> </span><span class="s2">&quot;${lib${BLIB_LIBNAME}};${ns3-libs}&quot;</span>
<span class="w">        </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of processed upstream modules&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-contrib-libs</span><span class="w"> </span><span class="s2">&quot;${lib${BLIB_LIBNAME}};${ns3-contrib-libs}&quot;</span>
<span class="w">        </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of processed contrib modules&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>In the following block, we check if we are working with Xcode, which does
not handle correctly CMake object libraries (.o files).</p>
<p>In other platforms,
we build an object file <code class="docutils literal notranslate"><span class="pre">add_library(${lib${BLIB_LIBNAME}-obj}</span> <span class="pre">OBJECT</span> <span class="pre">&quot;${BLIB_SOURCE_FILES}...)</span></code>
and a shared library <code class="docutils literal notranslate"><span class="pre">add_library(${lib${BLIB_LIBNAME}}</span> <span class="pre">SHARED</span> <span class="pre">...)</span></code>.</p>
<p>The object library contains the actual source files (<code class="docutils literal notranslate"><span class="pre">${BLIB_SOURCE_FILES}</span></code>),
but is not linked, which mean we can reuse the object to build the static version of the libraries.
Notice the shared library uses the object file as its source files
<code class="docutils literal notranslate"><span class="pre">$&lt;TARGET_OBJECTS:${lib${BLIB_LIBNAME}-obj}</span></code>.</p>
<p>Notice that we can also reuse precompiled headers created previously to speed up the
parsing phase of the compilation.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">XCODE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Create object library with sources and headers, that will be used in</span>
<span class="w">    </span><span class="c"># lib-ns3-static and the shared library</span>
<span class="w">    </span><span class="nb">add_library</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">-obj}</span><span class="w"> </span><span class="s">OBJECT</span><span class="w"> </span><span class="s2">&quot;${BLIB_SOURCE_FILES}&quot;</span>
<span class="w">                                      </span><span class="s2">&quot;${BLIB_HEADER_FILES}&quot;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">))</span>
<span class="w">      </span><span class="nb">target_precompile_headers</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">-obj}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Create shared library with previously created object library (saving</span>
<span class="w">    </span><span class="c"># compilation time for static libraries)</span>
<span class="w">    </span><span class="nb">add_library</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">SHARED</span><span class="w"> </span><span class="o">$&lt;</span><span class="nv">TARGET_OBJECTS:${lib${BLIB_LIBNAME}-obj}</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># Xcode and CMake don&#39;t play well when using object libraries, so we have a</span>
<span class="w">    </span><span class="c"># specific path for that</span>
<span class="w">    </span><span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">SHARED</span><span class="w"> </span><span class="s2">&quot;${BLIB_SOURCE_FILES}&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">))</span>
<span class="w">      </span><span class="nb">target_precompile_headers</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the next code block, we create an alias to <code class="docutils literal notranslate"><span class="pre">libmodule</span></code>, <code class="docutils literal notranslate"><span class="pre">ns3::libmodule</span></code>,
which can later be used when importing <em>ns-3</em> with CMake’s <code class="docutils literal notranslate"><span class="pre">find_package(ns3)</span></code>.</p>
<p>Then, we associate configured headers (<code class="docutils literal notranslate"><span class="pre">config-store-config</span></code>, <code class="docutils literal notranslate"><span class="pre">core-config.h</span></code> and
<code class="docutils literal notranslate"><span class="pre">version-defines.h</span></code>) to the core module.</p>
<p>And finally associate all of the public headers of the module to that library,
to make sure CMake will be refreshed in case one of them changes.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">add_library</span><span class="p">(</span><span class="s">ns3::</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">ALIAS</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Associate public headers with library for installation purposes</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${BLIB_LIBNAME}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span><span class="w"> </span><span class="s2">&quot;core&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">config_headers</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/config-store-config.h</span>
<span class="w">                      </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/core-config.h</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_ENABLE_BUILD_VERSION</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">config_headers</span>
<span class="w">          </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/version-defines.h</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">PROPERTIES</span>
<span class="w">      </span><span class="s">PUBLIC_HEADER</span>
<span class="w">      </span><span class="s2">&quot;${BLIB_HEADER_FILES};${BLIB_DEPRECATED_HEADER_FILES};${config_headers};${CMAKE_HEADER_OUTPUT_DIRECTORY}/${BLIB_LIBNAME}-module.h&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the next code block, we make the library a dependency to the ClangAnalyzer’s time trace report,
which measures which step of compilation took most time and which files were responsible for that.</p>
<p>Then, the <em>ns-3</em> libraries are separated from non-<em>ns-3</em> libraries, that can be propagated or not
for libraries/executables linked to the current <em>ns-3</em> module being processed.</p>
<p>The default is propagating these third-party libraries and their include directories, but this
can be turned off by setting <code class="docutils literal notranslate"><span class="pre">NS3_REEXPORT_THIRD_PARTY_LIBRARIES=OFF</span></code></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_CLANG_TIMETRACE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">add_dependencies</span><span class="p">(</span><span class="s">timeTraceReport</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Split ns and non-ns libraries to manage their propagation properly</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">non_ns_libraries_to_link</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">ns_libraries_to_link</span><span class="p">)</span>

<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">library</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_LIBRARIES_TO_LINK</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">remove_lib_prefix</span><span class="p">(</span><span class="s2">&quot;${library}&quot;</span><span class="w"> </span><span class="s">module_name</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Check if the module exists in the ns-3 modules list</span>
<span class="w">    </span><span class="c"># or if it is a 3rd-party library</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">module_name</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">ns3-all-enabled-modules</span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">ns_libraries_to_link</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">non_ns_libraries_to_link</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">unset</span><span class="p">(</span><span class="s">module_name</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">NS3_REEXPORT_THIRD_PARTY_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># ns-3 libraries are linked publicly, to make sure other modules can find</span>
<span class="w">    </span><span class="c"># each other without being directly linked</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">exported_libraries</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns_libraries_to_link</span><span class="o">}</span>
<span class="w">                          </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># non-ns-3 libraries are linked privately, not propagating unnecessary</span>
<span class="w">    </span><span class="c"># libraries such as pthread, librt, etc</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">private_libraries</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span>
<span class="w">                          </span><span class="o">${</span><span class="nv">non_ns_libraries_to_link</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># we don&#39;t re-export included libraries from 3rd-party modules</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">exported_include_directories</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># we export everything by default when NS3_REEXPORT_THIRD_PARTY_LIBRARIES=ON</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">exported_libraries</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns_libraries_to_link</span><span class="o">}</span>
<span class="w">                          </span><span class="o">${</span><span class="nv">non_ns_libraries_to_link</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">private_libraries</span><span class="p">)</span>

<span class="w">    </span><span class="c"># with NS3_REEXPORT_THIRD_PARTY_LIBRARIES, we export all 3rd-party library</span>
<span class="w">    </span><span class="c"># include directories, allowing consumers of this module to include and link</span>
<span class="w">    </span><span class="c"># the 3rd-party code with no additional setup</span>
<span class="w">    </span><span class="nb">get_target_includes</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">exported_include_directories</span><span class="p">)</span>
<span class="w">    </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;-I&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">exported_include_directories</span>
<span class="w">                  </span><span class="s2">&quot;${exported_include_directories}&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;${CMAKE_OUTPUT_DIRECTORY}/include&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">                  </span><span class="s">exported_include_directories</span>
<span class="w">                  </span><span class="s2">&quot;${exported_include_directories}&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>After the lists of libraries to link that should be exported (<code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code>) and
not exported (<code class="docutils literal notranslate"><span class="pre">PRIVATE</span></code>) are built, we can link them with <code class="docutils literal notranslate"><span class="pre">target_link_libraries</span></code>.</p>
<p>Next, we set the output name of the module library to <code class="docutils literal notranslate"><span class="pre">n3version-modulename</span></code> (+ optional build suffix).</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">exported_libraries</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">private_libraries</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># set output name of library</span>
<span class="w">  </span><span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">PROPERTIES</span><span class="w"> </span><span class="s">OUTPUT_NAME</span><span class="w"> </span><span class="s">ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>Next we export include directories, to let library consumers importing <em>ns-3</em> via CMake
use them just by linking to one of the <em>ns-3</em> modules.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># export include directories used by this library so that it can be used by</span>
<span class="w">  </span><span class="c"># 3rd-party consumers of ns-3 using find_package(ns3) this will automatically</span>
<span class="w">  </span><span class="c"># add the build/include path to them, so that they can ns-3 headers with</span>
<span class="w">  </span><span class="c"># &lt;ns3/something.h&gt;</span>
<span class="w">  </span><span class="nb">target_include_directories</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">$&lt;</span><span class="nv">BUILD_INTERFACE:${CMAKE_OUTPUT_DIRECTORY}/include</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">$&lt;</span><span class="nv">INSTALL_INTERFACE:include</span><span class="o">&gt;</span>
<span class="w">    </span><span class="s">INTERFACE</span><span class="w"> </span><span class="o">${</span><span class="nv">exported_include_directories</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>We append the list of third-party/external libraries for each processed module,
and append a list of object libraries that can be later used for the static <em>ns-3</em> build.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-external-libs</span><span class="w"> </span><span class="s2">&quot;${non_ns_libraries_to_link};${ns3-external-libs}&quot;</span>
<span class="w">      </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span>
<span class="w">            </span><span class="s2">&quot;list of non-ns libraries to link to NS3_STATIC and NS3_MONOLIB&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_STATIC</span><span class="o">}</span><span class="w"> </span><span class="s">OR</span><span class="w"> </span><span class="o">${</span><span class="nv">NS3_MONOLIB</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">lib-ns3-static-objs</span>
<span class="w">        </span><span class="s2">&quot;$&lt;TARGET_OBJECTS:${lib${BLIB_LIBNAME}-obj}&gt;;${lib-ns3-static-objs}&quot;</span>
<span class="w">        </span><span class="s">CACHE</span>
<span class="w">          </span><span class="s">INTERNAL</span>
<span class="w">          </span><span class="s2">&quot;list of object files from module used by NS3_STATIC and NS3_MONOLIB&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The following block creates the <code class="docutils literal notranslate"><span class="pre">${BLIB_LIBNAME}-module.h</span></code> header for user scripts,
and copies header files from <code class="docutils literal notranslate"><span class="pre">src/module</span></code> and <code class="docutils literal notranslate"><span class="pre">contrib/module</span></code> to the <code class="docutils literal notranslate"><span class="pre">include/ns3</span></code> directory.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Write a module header that includes all headers from that module</span>
<span class="w">  </span><span class="nb">write_module_header</span><span class="p">(</span><span class="s2">&quot;${BLIB_LIBNAME}&quot;</span><span class="w"> </span><span class="s2">&quot;${BLIB_HEADER_FILES}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Copy all header files to outputfolder/include before each build</span>
<span class="w">  </span><span class="nb">copy_headers_before_building_lib</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="w"> </span><span class="s2">&quot;${BLIB_HEADER_FILES}&quot;</span>
<span class="w">    </span><span class="s">public</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">BLIB_DEPRECATED_HEADER_FILES</span><span class="p">)</span>
<span class="w">    </span><span class="nb">copy_headers_before_building_lib</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span>
<span class="w">      </span><span class="s2">&quot;${BLIB_DEPRECATED_HEADER_FILES}&quot;</span><span class="w"> </span><span class="s">deprecated</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The following block creates the test library for the module currently being processed.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Check if the module tests should be built</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Build tests if requested</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_TESTS</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">filtered_in</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span><span class="s">LENGTH</span><span class="w"> </span><span class="s">BLIB_TEST_SOURCES</span><span class="w"> </span><span class="s">test_source_len</span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">test_source_len</span><span class="o">}</span><span class="w"> </span><span class="s">GREATER</span><span class="w"> </span><span class="s">0</span><span class="p">)</span>
<span class="w">      </span><span class="c"># Create BLIB_LIBNAME of output library test of module</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">test</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="s">lib</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="s">-test</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-libs-tests</span><span class="w"> </span><span class="s2">&quot;${test${BLIB_LIBNAME}};${ns3-libs-tests}&quot;</span>
<span class="w">          </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of test libraries&quot;</span>
<span class="w">      </span><span class="p">)</span>

<span class="w">      </span><span class="c"># Create shared library containing tests of the module</span>
<span class="w">      </span><span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">SHARED</span><span class="w"> </span><span class="s2">&quot;${BLIB_TEST_SOURCES}&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c"># Link test library to the module library</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_MONOLIB</span><span class="o">}</span><span class="p">)</span>
<span class="w">        </span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">          </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">lib-ns3-monolib</span><span class="o">}</span>
<span class="w">          </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="nb">else</span><span class="p">()</span>
<span class="w">        </span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">          </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">          </span><span class="s2">&quot;${BLIB_LIBRARIES_TO_LINK}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">      </span><span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">        </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">        </span><span class="s">PROPERTIES</span><span class="w"> </span><span class="s">OUTPUT_NAME</span>
<span class="w">                  </span><span class="s">ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="s">-test</span><span class="o">${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">      </span><span class="p">)</span>

<span class="w">      </span><span class="nb">target_compile_definitions</span><span class="p">(</span>
<span class="w">        </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">NS_TEST_SOURCEDIR=</span><span class="s2">&quot;${FOLDER}/test&quot;</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">))</span>
<span class="w">        </span><span class="nb">target_precompile_headers</span><span class="p">(</span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The following block checks for examples subdirectories and add them to parse their
CMakeLists.txt file, creating the examples. It also scans for python examples.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Build lib examples if requested</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_EXAMPLES</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">foreach</span><span class="p">(</span><span class="s">example_folder</span><span class="w"> </span><span class="s">example;examples</span><span class="p">)</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="s">EXISTS</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="p">)</span>
<span class="w">        </span><span class="nb">if</span><span class="p">(</span><span class="s">EXISTS</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="s">/CMakeLists.txt</span><span class="p">)</span>
<span class="w">          </span><span class="nb">add_subdirectory</span><span class="p">(</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="p">)</span>
<span class="w">        </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">        </span><span class="nb">scan_python_examples</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endforeach</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the next code block we add the library to the <code class="docutils literal notranslate"><span class="pre">ns3ExportTargets</span></code>, later used for installation.
We also print an additional message the folder just finished being processed if <code class="docutils literal notranslate"><span class="pre">NS3_VERBOSE</span></code> is set to <code class="docutils literal notranslate"><span class="pre">ON</span></code>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Handle package export</span>
<span class="w">  </span><span class="nb">install</span><span class="p">(</span>
<span class="w">    </span><span class="s">TARGETS</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">EXPORT</span><span class="w"> </span><span class="s">ns3ExportTargets</span>
<span class="w">    </span><span class="s">ARCHIVE</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_LIBDIR</span><span class="o">}</span><span class="s">/</span>
<span class="w">    </span><span class="s">LIBRARY</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_LIBDIR</span><span class="o">}</span><span class="s">/</span>
<span class="w">    </span><span class="s">PUBLIC_HEADER</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s2">&quot;${CMAKE_INSTALL_INCLUDEDIR}/ns3&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_VERBOSE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Processed ${FOLDER}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="module-macros-build-lib-example">
<span id="build-lib-example"></span><h5><span class="section-number">4.3.7.7.2.2. </span>Module macros: build_lib_example<a class="headerlink" href="#module-macros-build-lib-example" title="Link to this heading">¶</a></h5>
<p>The second most important macro from a module author perspective is the <code class="docutils literal notranslate"><span class="pre">build_lib_example</span></code>, which
builds the examples for their module. As with <code class="docutils literal notranslate"><span class="pre">build_lib</span></code> we explain what it does block-by-block.</p>
<p>In the first block, arguments are parsed and we check whether the current module is in the contrib
or the src folder.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib_example</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Argument parsing</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">NAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">LIBRARIES_TO_LINK</span><span class="p">)</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span><span class="s2">&quot;BLIB_EXAMPLE&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Get path src/module or contrib/module</span>
<span class="w">  </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">FOLDER</span><span class="w"> </span><span class="s2">&quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">get_filename_component</span><span class="p">(</span><span class="s">FOLDER</span><span class="w"> </span><span class="o">${</span><span class="nv">FOLDER</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>Then we check if the <em>ns-3</em> modules required by the example are enabled to be built.
If the list <code class="docutils literal notranslate"><span class="pre">missing_dependencies</span></code> is empty, we create the example. Otherwise, we skip it.
The example can be linked to the current module (<code class="docutils literal notranslate"><span class="pre">${lib${BLIB_EXAMPLE_LIBNAME}}</span></code>) and
other libraries to link (<code class="docutils literal notranslate"><span class="pre">${BLIB_EXAMPLE_LIBRARIES_TO_LINK}</span></code>) and optionally to the visualizer
module (<code class="docutils literal notranslate"><span class="pre">${ns3-optional-visualizer-lib}</span></code>).
If the visualizer module is not enabled, <code class="docutils literal notranslate"><span class="pre">ns3-optional-visualizer-lib</span></code> is empty.</p>
<p>The example can also be linked to a single <em>ns-3</em> shared library (<code class="docutils literal notranslate"><span class="pre">lib-ns3-monolib</span></code>) or
a single <em>ns-3</em> static library (<code class="docutils literal notranslate"><span class="pre">lib-ns3-static</span></code>), if either <code class="docutils literal notranslate"><span class="pre">NS3_MONOLIB=ON</span></code> or <code class="docutils literal notranslate"><span class="pre">NS3_STATIC=ON</span></code>.
Note that both of these options are handled by the <code class="docutils literal notranslate"><span class="pre">build_exec</span></code> macro.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib_example</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">check_for_missing_libraries</span><span class="p">(</span><span class="s">missing_dependencies</span><span class="w"> </span><span class="s2">&quot;${BLIB_EXAMPLE_LIBRARIES_TO_LINK}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Check if a module example should be built</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">((</span><span class="s">NOT</span><span class="w"> </span><span class="s">missing_dependencies</span><span class="p">)</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">filtered_in</span><span class="o">}</span><span class="p">)</span>
<span class="w">     </span><span class="c"># Convert boolean into text to forward argument</span>
<span class="w">     </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_IGNORE_PCH</span><span class="o">}</span><span class="p">)</span>
<span class="w">       </span><span class="nb">set</span><span class="p">(</span><span class="s">IGNORE_PCH</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">     </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">     </span><span class="c"># Create executable with sources and headers</span>
<span class="w">     </span><span class="c"># cmake-format: off</span>
<span class="w">     </span><span class="nb">build_exec</span><span class="p">(</span>
<span class="w">       </span><span class="s">EXECNAME</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_NAME</span><span class="o">}</span>
<span class="w">       </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_SOURCE_FILES</span><span class="o">}</span>
<span class="w">       </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_HEADER_FILES</span><span class="o">}</span>
<span class="w">       </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">         </span><span class="o">${</span><span class="nv">lib${BLIB_EXAMPLE_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_LIBRARIES_TO_LINK</span><span class="o">}</span>
<span class="w">         </span><span class="o">${</span><span class="nv">ns3-optional-visualizer-lib</span><span class="o">}</span>
<span class="w">       </span><span class="s">EXECUTABLE_DIRECTORY_PATH</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">FOLDER</span><span class="o">}</span><span class="s">/</span>
<span class="w">       </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">     </span><span class="c"># cmake-format: on</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="#build-exec">build_exec</a> macro will also set resulting folder where the example will end up
after built (e.g. build/src/module/examples). It does that by forwarding the
<code class="docutils literal notranslate"><span class="pre">EXECUTABLE_DIRECTORY_PATH</span></code> to the macro <code class="docutils literal notranslate"><span class="pre">set_runtime_outputdirectory</span></code>, which also
adds the proper <em>ns-3</em> version prefix and build type suffix to the executable.</p>
<p>As with the module libraries, we can also reuse precompiled headers here to speed up
the parsing step of compilation.
You can find more information about <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> at the <a class="reference internal" href="#pch-side-effects">PCH side-effects</a> section.</p>
</section>
</section>
<section id="user-options-and-header-checking">
<h4><span class="section-number">4.3.7.7.3. </span>User options and header checking<a class="headerlink" href="#user-options-and-header-checking" title="Link to this heading">¶</a></h4>
<p>User-settable options should be prefixed with <code class="docutils literal notranslate"><span class="pre">NS3_</span></code>, otherwise
they will not be preserved by <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">configure</span> <span class="pre">--force-refresh</span></code>.</p>
<p>After checking if the pre-requisites of the user-settable options
are met, set the same option now prefixed with <code class="docutils literal notranslate"><span class="pre">ENABLE_</span></code>. The
following example demonstrates this pattern:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Option() means the variable NS3_GSL will be set to ON/OFF</span>
<span class="c"># The second argument is a comment explaining what this option does</span>
<span class="c"># The last argument is the default value for the user-settable option</span>
<span class="nb">option</span><span class="p">(</span><span class="s">NS3_GSL</span><span class="w"> </span><span class="s2">&quot;Enable GSL related features&quot;</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Set the ENABLE\_ counterpart to FALSE by default</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_GSL</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_GSL</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># If the user enabled GSL, check if GSL is available</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">GSL</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">GSL_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_GSL</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GSL was requested by the user and was found&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GSL was not found and GSL features will continue disabled&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">else</span><span class="p">()</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GSL features were not requested by the user&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Now the module can check for ENABLE_GSL before being processed</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">ENABLE_GSL</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">return</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Or to enable optional features</span>
<span class="nb">set</span><span class="p">(</span><span class="s">gsl_sources</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_GSL</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">gsl_sources</span><span class="w"> </span><span class="s">model/gsl_features.cc</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>Here are examples of how to do the options and header checking,
followed by a header configuration:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># We always set the ENABLE\_ counterpart of NS3\_ option to FALSE before checking</span>
<span class="c">#</span>
<span class="c"># If this variable is created inside your module, use</span>
<span class="c"># set(ENABLE_MPI FALSE CACHE INTERNAL &quot;&quot;)</span>
<span class="c"># instead, to make it globally available</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_MPI</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>

<span class="c"># If the user option switch is set to ON, we check</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_MPI</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Use find_package to look for MPI</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">  </span><span class="c"># If the package is optional, which is the case for MPI,</span>
<span class="w">  </span><span class="c"># we can proceed if it is not found</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">MPI_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;MPI was not found. Continuing without it.&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># If it is false, we add necessary C++ definitions (e.g. NS3_MPI)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;MPI was found.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-DNS3_MPI</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Then set ENABLE_MPI to TRUE, which can be used to check</span>
<span class="w">    </span><span class="c"># if NS3_MPI is enabled AND MPI was found</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># If this variable is created inside your module, use</span>
<span class="w">    </span><span class="c"># set(ENABLE_MPI TRUE CACHE INTERNAL &quot;&quot;)</span>
<span class="w">    </span><span class="c"># instead, to make it globally available</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_MPI</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># ...</span>

<span class="c"># These two standard CMake modules allow for header and function checking</span>
<span class="nb">include</span><span class="p">(</span><span class="s">CheckIncludeFileCXX</span><span class="p">)</span>
<span class="nb">include</span><span class="p">(</span><span class="s">CheckFunctionExists</span><span class="p">)</span>

<span class="c"># Check for required headers and functions,</span>
<span class="c"># set flags on the right argument if header in the first argument is found</span>
<span class="c"># if they are not found, a warning is emitted</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;stdint.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_STDINT_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;inttypes.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_INTTYPES_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;sys/types.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_SYS_TYPES_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;stat.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_SYS_STAT_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;dirent.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_DIRENT_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;stdlib.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_STDLIB_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;signal.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_SIGNAL_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;netpacket/packet.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_PACKETH&quot;</span><span class="p">)</span>
<span class="nb">check_function_exists</span><span class="p">(</span><span class="s2">&quot;getenv&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_GETENV&quot;</span><span class="p">)</span>

<span class="c"># This is the CMake command to open up a file template (in this case a header</span>
<span class="c"># passed as the first argument), then fill its fields with values stored in</span>
<span class="c"># CMake variables and save the resulting file to the target destination</span>
<span class="c"># (in the second argument)</span>
<span class="nb">configure_file</span><span class="p">(</span>
<span class="w">  </span><span class="s">build-support/core-config-template.h</span>
<span class="w">  </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/core-config.h</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The configure_file command is not very clear by itself, as you do not know which
values are being used. So we need to check the template.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef NS3_CORE_CONFIG_H</span>
<span class="cp">#define NS3_CORE_CONFIG_H</span>

<span class="c1">// Defined if HAVE_UINT128_T is defined in CMake</span>
<span class="cp">#cmakedefine   HAVE_UINT128_T</span>
<span class="c1">// Set to 1 if HAVE__UINT128_T is defined in CMake, 0 otherwise</span>
<span class="cp">#cmakedefine01 HAVE___UINT128_T</span>
<span class="cp">#cmakedefine   INT64X64_USE_128</span>
<span class="cp">#cmakedefine   INT64X64_USE_DOUBLE</span>
<span class="cp">#cmakedefine   INT64X64_USE_CAIRO</span>
<span class="cp">#cmakedefine01 HAVE_STDINT_H</span>
<span class="cp">#cmakedefine01 HAVE_INTTYPES_H</span>
<span class="cp">#cmakedefine   HAVE_SYS_INT_TYPES_H</span>
<span class="cp">#cmakedefine01 HAVE_SYS_TYPES_H</span>
<span class="cp">#cmakedefine01 HAVE_SYS_STAT_H</span>
<span class="cp">#cmakedefine01 HAVE_DIRENT_H</span>
<span class="cp">#cmakedefine01 HAVE_STDLIB_H</span>
<span class="cp">#cmakedefine01 HAVE_GETENV</span>
<span class="cp">#cmakedefine01 HAVE_SIGNAL_H</span>

<span class="cm">/*</span>
<span class="cm">* #cmakedefine turns into:</span>
<span class="cm">* //#define HAVE_FLAG // if HAVE_FLAG is not defined in CMake (e.g. unset(HAVE_FLAG))</span>
<span class="cm">* #define HAVE_FLAG // if HAVE_FLAG is defined in CMake (e.g. set(HAVE_FLAG))</span>
<span class="cm">*</span>
<span class="cm">* #cmakedefine01 turns into:</span>
<span class="cm">* #define HAVE_FLAG 0 // if HAVE_FLAG is not defined in CMake</span>
<span class="cm">* #define HAVE_FLAG 1 // if HAVE_FLAG is defined in CMake</span>
<span class="cm">*/</span>

<span class="cp">#endif </span><span class="c1">//NS3_CORE_CONFIG_H</span>
</pre></div>
</div>
</section>
<section id="custom-targets">
<h4><span class="section-number">4.3.7.7.4. </span>Custom targets<a class="headerlink" href="#custom-targets" title="Link to this heading">¶</a></h4>
<p>Another common thing to do is implement custom targets that run specific commands and
manage dependencies. Here is an example for Doxygen:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># This command hides DOXYGEN from some CMake cache interfaces</span>
<span class="nb">mark_as_advanced</span><span class="p">(</span><span class="s">DOXYGEN</span><span class="p">)</span>

<span class="c"># This custom macro checks for dependencies CMake find_package and program</span>
<span class="c"># dependencies and return the missing dependencies in the third argument</span>
<span class="nb">check_deps</span><span class="p">(</span><span class="s">doxygen_docs_missing_deps</span><span class="w"> </span><span class="s">EXECUTABLES</span><span class="w"> </span><span class="s">doxygen</span><span class="w"> </span><span class="s">dot</span><span class="w"> </span><span class="s">dia</span><span class="w"> </span><span class="s">python3</span><span class="p">)</span>

<span class="c"># If the variable contains missing dependencies, we stop processing doxygen targets</span>
<span class="nb">if</span><span class="p">(</span><span class="s">doxygen_docs_missing_deps</span><span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span>
<span class="w">    </span><span class="s">STATUS</span>
<span class="w">      </span><span class="s2">&quot;docs: doxygen documentation not enabled due to missing dependencies: ${doxygen_docs_missing_deps}&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
<span class="w">  </span><span class="c"># We checked this already exists, but we need the path to the executable</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">Doxygen</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Get introspected doxygen</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">run-print-introspected-doxygen</span>
<span class="w">    </span><span class="s">COMMAND</span>
<span class="w">      </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/utils/ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-print-introspected-doxygen</span><span class="o">${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">      </span><span class="s">&gt;</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/introspected-doxygen.h</span>
<span class="w">    </span><span class="s">COMMAND</span>
<span class="w">      </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/utils/ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-print-introspected-doxygen</span><span class="o">${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">      </span><span class="s">--output-text</span><span class="w"> </span><span class="s">&gt;</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/ns3-object.txt</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">print-introspected-doxygen</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Run test.py with NS_COMMANDLINE_INTROSPECTION=.. to print examples</span>
<span class="w">  </span><span class="c"># introspected commandline</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">run-introspected-command-line</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_COMMAND</span><span class="o">}</span><span class="w"> </span><span class="s">-E</span><span class="w"> </span><span class="s">env</span><span class="w"> </span><span class="s">NS_COMMANDLINE_INTROSPECTION=..</span>
<span class="w">            </span><span class="o">${</span><span class="nv">Python_EXECUTABLE</span><span class="o">}</span><span class="w"> </span><span class="s">./test.py</span><span class="w"> </span><span class="s">--no-build</span><span class="w"> </span><span class="s">--constrain=example</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">all-test-targets</span><span class="w"> </span><span class="c"># all-test-targets only exists if ENABLE_TESTS is</span>
<span class="w">                             </span><span class="c"># set to ON</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># This file header is written during configuration</span>
<span class="w">  </span><span class="nb">file</span><span class="p">(</span>
<span class="w">    </span><span class="s">WRITE</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/introspected-command-line.h</span>
<span class="w">    </span><span class="s2">&quot;/* This file is automatically generated by</span>
<span class="s2">CommandLine::PrintDoxygenUsage() from the CommandLine configuration</span>
<span class="s2">in various example programs.  Do not edit this file!  Edit the</span>
<span class="s2">CommandLine configuration in those files instead.</span>
<span class="s2">*/</span>
<span class="s2">\n&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># After running test.py for the introspected commandline above,</span>
<span class="w">  </span><span class="c"># merge outputs and concatenate to the header file created during</span>
<span class="w">  </span><span class="c"># configuration</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">assemble-introspected-command-line</span>
<span class="w">    </span><span class="c"># works on CMake 3.18 or newer &gt; COMMAND ${CMAKE_COMMAND} -E cat</span>
<span class="w">    </span><span class="c"># ${PROJECT_SOURCE_DIR}/testpy-output/*.command-line &gt;</span>
<span class="w">    </span><span class="c"># ${PROJECT_SOURCE_DIR}/doc/introspected-command-line.h</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">cat_command</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/testpy-output/*.command-line</span>
<span class="w">            </span><span class="s">&gt;</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/introspected-command-line.h</span><span class="w"> </span><span class="s">2&gt;</span><span class="w"> </span><span class="s">NULL</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">run-introspected-command-line</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Create a target that updates the doxygen version</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">update_doxygen_version</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/ns3_html_theme/get_version.sh</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Create a doxygen target that builds the documentation and only runs</span>
<span class="w">  </span><span class="c"># after the version target above was executed, the introspected doxygen</span>
<span class="w">  </span><span class="c"># and command line were extracted</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">doxygen</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">DOXYGEN_EXECUTABLE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/doxygen.conf</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">update_doxygen_version</span><span class="w"> </span><span class="s">run-print-introspected-doxygen</span>
<span class="w">            </span><span class="s">assemble-introspected-command-line</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Create a doxygen target that only needs to run the version target</span>
<span class="w">  </span><span class="c"># which doesn&#39;t trigger compilation of examples neither the execution of test.py</span>
<span class="w">  </span><span class="c"># nor print-introspected-doxygen</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">doxygen-no-build</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">DOXYGEN_EXECUTABLE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/doxygen.conf</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">update_doxygen_version</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="project-wide-compiler-and-linker-flags">
<h4><span class="section-number">4.3.7.7.5. </span>Project-wide compiler and linker flags<a class="headerlink" href="#project-wide-compiler-and-linker-flags" title="Link to this heading">¶</a></h4>
<p>Different compilers and links accept different flags, which must be
known during configuration time. Some of these flags are
handled directly by CMake:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># equivalent to -fPIC for libraries and -fPIE for executables</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_POSITION_INDEPENDENT_CODE</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="c"># link-time optimization flags such as -flto and -flto=thin</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_INTERPROCEDURAL_OPTIMIZATION</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>

<span class="c"># C++ standard flag to use</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD_MINIMUM</span><span class="w"> </span><span class="s">17</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD_REQUIRED</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">static_lib</span><span class="w"> </span><span class="s">STATIC</span><span class="p">)</span><span class="w"> </span><span class="c"># equivalent to -static flag</span>
<span class="nb">add_library</span><span class="p">(</span><span class="s">shared_lib</span><span class="w"> </span><span class="s">SHARED</span><span class="p">)</span><span class="w"> </span><span class="c"># equivalent to -shared flags</span>
</pre></div>
</div>
<p>Other flags need to be handled manually and change based on
the compiler used. The most commonly used are handled in
<code class="docutils literal notranslate"><span class="pre">build-support/macros-and-definitions.cmake</span></code>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_PRE</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">GCC</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="s">NOT</span><span class="w"> </span><span class="s">APPLE</span><span class="p">)</span>
<span class="w">  </span><span class="c"># using GCC</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_PRE</span><span class="w"> </span><span class="s">-Wl,--no-as-needed</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST</span><span class="w"> </span><span class="s">-Wl,--as-needed</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_PRE_STATIC</span><span class="w"> </span><span class="s">-Wl,--whole-archive,-Bstatic</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST_STATIC</span><span class="w"> </span><span class="s">-Wl,--no-whole-archive</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST_STATIC_DYN</span><span class="w"> </span><span class="s">-Wl,-Bdynamic,--no-whole-archive</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">LIB_AS_NEEDED</span></code> values are used to force linking of all symbols,
and not only those explicitly used by the applications, which is necessary
since simulation scripts don’t directly use most of the symbols exported
by the modules. Their use can be seen in the <code class="docutils literal notranslate"><span class="pre">utils/CMakeLists.txt</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">    </span><span class="s">test-runner</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns3-libs-tests</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">ns3-libs</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns3-contrib-libs</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
<p>This will ensure test-runner linking to <code class="docutils literal notranslate"><span class="pre">ns3-libs-tests</span></code> (list containing all
module test libraries) with all symbols, which will make it able to find and run
all tests. The other two lists <code class="docutils literal notranslate"><span class="pre">ns3-libs</span></code> (src modules) and <code class="docutils literal notranslate"><span class="pre">ns3-contrib-libs</span></code>
(contrib modules) don’t need to be completely linked since the tests libraries are
already linked to them.</p>
<p>Other project-wide compiler-dependent flags can be set during compiler checking.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Check if the compiler is GCC</span>
<span class="nb">set</span><span class="p">(</span><span class="s">GCC</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${CMAKE_CXX_COMPILER_ID}&quot;</span><span class="w"> </span><span class="s">MATCHES</span><span class="w"> </span><span class="s2">&quot;GNU&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Check if GCC is a supported version</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">CMAKE_CXX_COMPILER_VERSION</span><span class="w"> </span><span class="s">VERSION_LESS</span><span class="w"> </span><span class="o">${</span><span class="nv">GNU_MinVersion</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span>
<span class="w">      </span><span class="s">FATAL_ERROR</span>
<span class="w">        </span><span class="s2">&quot;GNU ${CMAKE_CXX_COMPILER_VERSION} ${below_minimum_msg} ${GNU_MinVersion}&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># If GCC is up-to-date, set flag to true and continue</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">GCC</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Disable semantic interposition</span>
<span class="w">  </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-fno-semantic-interposition</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-fno-semantic-interposition</span></code> flag <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/777">disables semantic interposition</a>, which can
reduce overhead of function calls in shared libraries built with <code class="docutils literal notranslate"><span class="pre">-fPIC</span></code>.
This is the default behaviour for Clang. The inlined <em>ns-3</em> calls will not be
correctly interposed by the <code class="docutils literal notranslate"><span class="pre">LD_PRELOAD</span></code> trick, which is not know to be used by <em>ns-3</em> users.
To re-enable semantic interposition, comment out the line and reconfigure the project.</p>
<p>Note: the most common use of the <code class="docutils literal notranslate"><span class="pre">LD_PRELOAD</span></code> trick is to use custom memory allocators,
and this continues to work since the interposed symbols are from the standard libraries,
which are compiled with semantic interposition.</p>
<p>Some modules may require special flags. The Openflow module for example
may require <code class="docutils literal notranslate"><span class="pre">-Wno-stringop-truncation</span></code> flag to prevent an warning that
is treated as error to prevent the compilation from proceeding. The flag
can be passed to the entire module with the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wno-stringop-truncation</span><span class="p">)</span>

<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.cc</span>
<span class="w">    </span><span class="s">model/openflow-interface.cc</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.h</span>
<span class="w">    </span><span class="s">model/openflow-interface.h</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">openflow_LIBRARIES</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="s">test/openflow-switch-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If a flag prevents your compiler from compiling, wrap the flag inside a
compiler check. The currently checked compilers are <code class="docutils literal notranslate"><span class="pre">GCC</span></code> and <code class="docutils literal notranslate"><span class="pre">CLANG</span></code>
(includes both upstream LLVM Clang and Apple Clang).</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">FAILING_COMPILER</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wno-stringop-truncation</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># or</span>

<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ONLY_COMPILER_THAT_SUPPORTS_UNIQUE_FLAG</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-unique_flag</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="ccache-and-precompiled-headers">
<h2><span class="section-number">4.3.8. </span>CCache and Precompiled Headers<a class="headerlink" href="#ccache-and-precompiled-headers" title="Link to this heading">¶</a></h2>
<p>There are a few ways of speeding up the build of <em>ns-3</em> and its modules.
Partially rebuilding only changed modules is one of the ways, and
this is already handled by the build system.</p>
<p>However, cleaning up the build and cmake cache directories removes
the intermediate and final files that could be used to skip the build
of unchanged modules.</p>
<p>In this case, <a class="reference external" href="https://ccache.dev/">CCache</a> is recommended. It acts as a compiler and stores the
intermediate and final object files and libraries on a cache artifact directory.</p>
<p>Note: for ease of use, CCache is enabled by default if found by the build system.</p>
<p>The cache artifact directory of CCACHE can be set by changing the
<code class="docutils literal notranslate"><span class="pre">CCACHE_BASEDIR</span></code> environment variable.</p>
<p>The CCache artifact cache is separated per directory, to prevent incompatible
artifacts, which may depend on different working directories <code class="docutils literal notranslate"><span class="pre">CWD</span></code> to work properly
from getting mixed and producing binaries that will start running from a different directory.</p>
<p>Note: to reuse CCache artifacts from different directories,
set the <code class="docutils literal notranslate"><span class="pre">CCACHE_NOHASHDIR</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<p>A different way of speeding up builds is by using Precompiled Headers (<a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/Precompiled-Headers.html">PCHs</a>).
PCHs drastically reduce parsing times of C and C++ headers by precompiling their symbols,
which are imported instead of re-parsing the same headers again and again,
for each compilation unit (.cc file).</p>
<p>Note: for ease of use, PCH is enabled by default if supported. It can be manually disabled
by setting <code class="docutils literal notranslate"><span class="pre">NS3_PRECOMPILE_HEADERS</span></code> to <code class="docutils literal notranslate"><span class="pre">OFF</span></code>.</p>
<section id="setting-up-and-adding-new-headers-to-the-pch">
<h3><span class="section-number">4.3.8.1. </span>Setting up and adding new headers to the PCH<a class="headerlink" href="#setting-up-and-adding-new-headers-to-the-pch" title="Link to this heading">¶</a></h3>
<p>When both CCache and PCH are used together, there is a set of settings that must be
properly configured, otherwise timestamps built into the PCH can invalidate the CCache
artifacts, forcing a new build of unmodified modules/programs.</p>
<p>Compiler settings required by PCH and CCache are set in the PCH block in macros-and-definitions.cmake.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">CLANG</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Clang adds a timestamp to the PCH, which prevents ccache from working</span>
<span class="w">    </span><span class="c"># correctly</span>
<span class="w">    </span><span class="c"># https://github.com/ccache/ccache/issues/539#issuecomment-664198545</span>
<span class="w">    </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-Xclang</span><span class="w"> </span><span class="s">-fno-pch-timestamp</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">XCODE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># XCode is weird and messes up with the PCH, requiring this flag</span>
<span class="w">    </span><span class="c"># https://github.com/ccache/ccache/issues/156</span>
<span class="w">    </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-Xclang</span><span class="w"> </span><span class="s">-fno-validate-pch</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Headers that will be compiled into the PCH</span>
<span class="w">  </span><span class="c"># Only worth for frequently included headers</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">precompiled_header_libraries</span>
<span class="w">      </span><span class="s">&lt;algorithm&gt;</span>
<span class="w">      </span><span class="s">&lt;cstdlib&gt;</span>
<span class="w">      </span><span class="s">&lt;cstring&gt;</span>
<span class="w">      </span><span class="s">&lt;exception&gt;</span>
<span class="w">      </span><span class="s">&lt;fstream&gt;</span>
<span class="w">      </span><span class="s">&lt;iostream&gt;</span>
<span class="w">      </span><span class="s">&lt;limits&gt;</span>
<span class="w">      </span><span class="s">&lt;list&gt;</span>
<span class="w">      </span><span class="s">&lt;map&gt;</span>
<span class="w">      </span><span class="s">&lt;math.h&gt;</span>
<span class="w">      </span><span class="s">&lt;ostream&gt;</span>
<span class="w">      </span><span class="s">&lt;set&gt;</span>
<span class="w">      </span><span class="s">&lt;sstream&gt;</span>
<span class="w">      </span><span class="s">&lt;stdint.h&gt;</span>
<span class="w">      </span><span class="s">&lt;stdlib.h&gt;</span>
<span class="w">      </span><span class="s">&lt;string&gt;</span>
<span class="w">      </span><span class="s">&lt;unordered_map&gt;</span>
<span class="w">      </span><span class="s">&lt;vector&gt;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># PCHs can be reused by similar targets (libraries or executables)</span>
<span class="w">  </span><span class="c"># We have a PCH for libraries, compiled with the -fPIC flag</span>
<span class="w">  </span><span class="nb">add_library</span><span class="p">(</span><span class="s">stdlib_pch</span><span class="w"> </span><span class="s">OBJECT</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/build-support/empty.cc</span><span class="p">)</span>
<span class="w">  </span><span class="nb">target_precompile_headers</span><span class="p">(</span>
<span class="w">    </span><span class="s">stdlib_pch</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s2">&quot;${precompiled_header_libraries}&quot;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># And another PCH for executables, compiled with the -fPIE flag</span>
<span class="w">  </span><span class="nb">add_executable</span><span class="p">(</span>
<span class="w">    </span><span class="s">stdlib_pch_exec</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/build-support/empty-main.cc</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">target_precompile_headers</span><span class="p">(</span>
<span class="w">    </span><span class="s">stdlib_pch_exec</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s2">&quot;${precompiled_header_libraries}&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">set_runtime_outputdirectory</span><span class="p">(</span><span class="s">stdlib_pch_exec</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="o">}</span><span class="s">/</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The CCache settings required to work with PCH are set in the main CMakeLists.txt file:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Use ccache if available</span>
<span class="nb">mark_as_advanced</span><span class="p">(</span><span class="s">CCACHE</span><span class="p">)</span>
<span class="nb">find_program</span><span class="p">(</span><span class="s">CCACHE</span><span class="w"> </span><span class="s">ccache</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;${CCACHE}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span><span class="w"> </span><span class="s2">&quot;CCACHE-NOTFOUND&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="nb">set_property</span><span class="p">(</span><span class="s">GLOBAL</span><span class="w"> </span><span class="s">PROPERTY</span><span class="w"> </span><span class="s">RULE_LAUNCH_COMPILE</span><span class="w"> </span><span class="s">ccache</span><span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;CCache is enabled.&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Changes user-wide settings from CCache to make it ignore:</span>
<span class="w">  </span><span class="c"># - PCH definitions,</span>
<span class="w">  </span><span class="c"># - time related macros that could bake timestamps into cached artifacts,</span>
<span class="w">  </span><span class="c"># - source file creation and modification timestamps,</span>
<span class="w">  </span><span class="c">#    forcing it to check for content changes instead</span>
<span class="w">  </span><span class="nb">execute_process</span><span class="p">(</span>
<span class="w">    </span><span class="s">COMMAND</span>
<span class="w">      </span><span class="o">${</span><span class="nv">CCACHE</span><span class="o">}</span><span class="w"> </span><span class="s">--set-config</span>
<span class="w">      </span><span class="s">sloppiness=pch_defines,time_macros,include_file_mtime,include_file_ctime</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>Note: you can use the following commands to manually check
and restore the CCache sloppiness settings.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ccache --get-config sloppiness</span>
<span class="go">include_file_mtime, include_file_ctime, time_macros, pch_defines</span>
<span class="go">~$ ccache --set-config sloppiness=&quot;&quot;</span>
<span class="go">~$ ccache --get-config sloppiness</span>

<span class="go">~$</span>
</pre></div>
</div>
<p>The PCHs can be reused later with one of the following.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span><span class="s">example_lib</span><span class="w"> </span><span class="s">example_lib.cc</span><span class="p">)</span>
<span class="nb">target_precompile_headers</span><span class="p">(</span><span class="s">example_lib</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="s">example_exec</span><span class="w"> </span><span class="s">example_exec.cc</span><span class="p">)</span>
<span class="nb">target_precompile_headers</span><span class="p">(</span><span class="s">example_exec</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch_exec</span><span class="p">)</span>
</pre></div>
</div>
<p>If if you have problems with the build times when the PCH is enabled,
you can diagnose issues with CCache by clearing the cache statistics (<code class="docutils literal notranslate"><span class="pre">ccache</span> <span class="pre">-z</span></code>),
then cleaning, configuring, building, and finally printing the CCache statistics (<code class="docutils literal notranslate"><span class="pre">ccache</span> <span class="pre">-s</span></code>).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccache -z</span>
<span class="go">./ns3 clean</span>
<span class="go">./ns3 configure</span>
<span class="go">./ns3 build</span>
<span class="go">ccache -s</span>
</pre></div>
</div>
<p>If you have changed any compiler flag, the cache hit rate should be very low.
Repeat the same commands once more.
If the cache hit rate is at 100%, it means everything is working as it should.</p>
</section>
<section id="possible-side-effects-fixes-and-ignore-pch">
<span id="pch-side-effects"></span><h3><span class="section-number">4.3.8.2. </span>Possible side-effects, fixes and IGNORE_PCH<a class="headerlink" href="#possible-side-effects-fixes-and-ignore-pch" title="Link to this heading">¶</a></h3>
<p>Precompiled headers can cause symbol collisions due to includes reordering or unwanted includes,
which can lead to attempts to redefine functions, macros, types or variables.
An example of such side-effect is shown below.</p>
<p>In order to exemplify how precompiled headers can cause issues, assume the following inclusion order from
<code class="docutils literal notranslate"><span class="pre">ns-3-dev/src/aodv/model/aodv-routing-protocol.cc</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="cp">if (m_ipv4) { std::clog &lt;&lt; &quot;[node &quot; &lt;&lt; m_ipv4-&gt;GetObject&lt;Node&gt; ()-&gt;GetId () &lt;&lt; &quot;] &quot;; }</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;aodv-routing-protocol.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/log.h&quot;</span>
<span class="p">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">NS_LOG_APPEND_CONTEXT</span></code> macro definition comes before the <code class="docutils literal notranslate"><span class="pre">ns3/log.h</span></code> inclusion,
and that is the expected way of using <code class="docutils literal notranslate"><span class="pre">NS_LOG_APPEND_CONTEXT</span></code>, since we have the following
guards on <code class="docutils literal notranslate"><span class="pre">ns3/log-macros-enabled.h</span></code>, which is included by <code class="docutils literal notranslate"><span class="pre">ns3/log.h</span></code> when logs are enabled.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="cp">#ifndef NS_LOG_APPEND_CONTEXT</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT</span>
<span class="cp">#endif </span><span class="cm">/* NS_LOG_APPEND_CONTEXT */</span>
<span class="p">...</span>
</pre></div>
</div>
<p>By adding <code class="docutils literal notranslate"><span class="pre">&lt;ns3/log.h&gt;</span></code> to the list of headers to precompile (<code class="docutils literal notranslate"><span class="pre">precompiled_header_libraries</span></code>)
in <code class="docutils literal notranslate"><span class="pre">ns-3-dev/build-support/macros-and-definitions.cmake</span></code>, the <code class="docutils literal notranslate"><span class="pre">ns3/log.h</span></code> header will
now be part of the PCH, which gets included before any parsing of the code is done.
This means the equivalent inclusion order would be different than what was originally intended,
as shown below:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cmake_pch.hxx&quot;</span><span class="c1"> // PCH includes ns3/log.h before defining ``NS_LOG_APPEND_CONTEXT`` below</span>
<span class="p">...</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="cp">if (m_ipv4) { std::clog &lt;&lt; &quot;[node &quot; &lt;&lt; m_ipv4-&gt;GetObject&lt;Node&gt; ()-&gt;GetId () &lt;&lt; &quot;] &quot;; }</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;aodv-routing-protocol.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/log.h&quot;</span><span class="c1"> // isn&#39;t processed since ``NS3_LOG_H`` was already defined by the PCH</span>
<span class="p">...</span>
</pre></div>
</div>
<p>While trying to build with the redefined symbols in the debug build, where warnings are treated
as errors, the build may fail with an error similar to the following from GCC 11.2:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">FAILED: src/aodv/CMakeFiles/libaodv-obj.dir/model/aodv-routing-protocol.cc.o</span>
<span class="go">ccache /usr/bin/c++ ... -DNS3_LOG_ENABLE -Wall -Werror -include /ns-3-dev/cmake-build-debug/CMakeFiles/stdlib_pch.dir/cmake_pch.hxx</span>
<span class="go">/ns-3-dev/src/aodv/model/aodv-routing-protocol.cc:28: error: &quot;NS_LOG_APPEND_CONTEXT&quot; redefined [-Werror]</span>
<span class="go">   28 | #define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="go">      |</span>
<span class="go">In file included from /ns-3-dev/src/core/model/log.h:32,</span>
<span class="go">                 from /ns-3-dev/src/core/model/fatal-error.h:29,</span>
<span class="go">                 from /ns-3-dev/build/include/ns3/assert.h:56,</span>
<span class="go">                 from /ns-3-dev/build/include/ns3/buffer.h:26,</span>
<span class="go">                 from /ns-3-dev/build/include/ns3/packet.h:24,</span>
<span class="go">                 from /ns-3-dev/cmake-build-debug/CMakeFiles/stdlib_pch.dir/cmake_pch.hxx:23,</span>
<span class="go">                 from &lt;command-line&gt;:</span>
<span class="go">/ns-3-dev/src/core/model/log-macros-enabled.h:146: note: this is the location of the previous definition</span>
<span class="go">  146 | #define NS_LOG_APPEND_CONTEXT</span>
<span class="go">      |</span>
<span class="go">cc1plus: all warnings being treated as errors</span>
</pre></div>
</div>
<p>One of the ways to fix this issue in particular is undefining <code class="docutils literal notranslate"><span class="pre">NS_LOG_APPEND_CONTEXT</span></code> before redefining it in
<code class="docutils literal notranslate"><span class="pre">/ns-3-dev/src/aodv/model/aodv-routing-protocol.cc</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cmake_pch.hxx&quot;</span><span class="c1"> // PCH includes ns3/log.h before defining NS_LOG_APPEND_CONTEXT below</span>
<span class="p">...</span>
<span class="cp">#undef NS_LOG_APPEND_CONTEXT </span><span class="c1">// undefines symbol previously defined in the PCH</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="cp">if (m_ipv4) { std::clog &lt;&lt; &quot;[node &quot; &lt;&lt; m_ipv4-&gt;GetObject&lt;Node&gt; ()-&gt;GetId () &lt;&lt; &quot;] &quot;; }</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;aodv-routing-protocol.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/log.h&quot;</span><span class="c1"> // isn&#39;t processed since ``NS3_LOG_H`` was already defined by the PCH</span>
<span class="p">...</span>
</pre></div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> option is set in the <a class="reference internal" href="#build-lib">build_lib</a>, <a class="reference internal" href="#build-lib-example">build_lib_example</a>, <a class="reference internal" href="#build-exec">build_exec</a> and the <a class="reference internal" href="#build-example">build_example</a>
macros, the PCH is not included in their targets, continuing to build as we normally would without the PCH.
This is only a workaround for the issue, which can be helpful when the same macro names, class names,
global variables and others are redefined by different components that can’t be modified safely.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">ns-3</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, vishnu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/doc/manual/source/working-with-cmake.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>